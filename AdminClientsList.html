{% extends "Global/Base.html" %}

{% block Title %}مدیریت کاربران | پنل آیروکاپ{% endblock %}

{% block Body %}
<div class="Container">
  <div class="PageHeader">
    <h1 class="SectionTitle">مدیریت کاربران</h1>
    <p class="FormSubtitle">افزودن و مدیریت تمام کاربران ثبت شده در سیستم.</p>
  </div>

  <div class="Toolbar">
    <button class="Btn BtnPrimary" data-modal-target="addClientModal">
      <i class="fas fa-plus"></i> افزودن کاربر جدید
    </button>
    <div class="SearchInputGroup">
      <i class="fas fa-search"></i>
      <input type="search" id="ClientSearchInput" class="FormControl" placeholder="جستجو بر اساس ایمیل یا شماره تماس..." aria-label="جستجوی کاربران" />
    </div>
  </div>

  <div class="Card Card--table">
    <h2 class="Card__header"><i class="fas fa-users"></i> لیست کاربران</h2>
    <div class="UserTableWrapper">
      <table class="UserTable" id="clients-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>ایمیل</th>
            <th>شماره تماس</th>
            <th>تاریخ ثبت نام</th>
            <th class="ActionsHeader">عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for ClientData in Clients %}
          <tr>
            <td>#{{ ClientData.ClientID | persian_digits }}</td>
            <td dir="ltr">{{ ClientData.Email }}</td>
            <td dir="ltr">{{ ClientData.PhoneNumber | persian_digits }}</td>
            <td>
              {{ ClientData.RegistrationDate | formatdate | persian_digits }}
            </td>
            <td class="Actions">
              <a href="{{ url_for('Admin.AdminManageClient', ClientID=ClientData.ClientID) }}" class="Btn BtnPrimary">
                <i class="fas fa-tasks"></i> مدیریت
              </a>
              <form method="POST" action="{{ url_for('Admin.AdminDeleteClient', ClientID=ClientData.ClientID) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="button" class="Btn BtnDanger DeleteBtn" data-modal-title="تایید آرشیو کاربر" data-modal-text="آیا از آرشیو کردن کاربر {{ ClientData.Email }} اطمینان دارید؟" data-modal-confirm="بله، آرشیو کن">
                  <i class="fas fa-archive"></i> آرشیو
                </button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr class="EmptyStateRow">
            <td colspan="5" class="EmptyState">
              <i class="fas fa-users EmptyState__icon"></i>
              هیچ کاربری برای نمایش یافت نشد.
            </td>
          </tr>
          {% endfor %}
          <tr id="NoResultsMessage" class="EmptyStateRow" style="display: none">
            <td colspan="5" class="EmptyState">
              <i class="fas fa-search EmptyState__icon"></i>
              هیچ کاربری با مشخصات وارد شده یافت نشد.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    {% if TotalPagesCount > 1 %}
    <div class="Pagination">
      {% if CurrentPage > 1 %}
      <a href="{{ url_for('Admin.AdminClientsList', page=CurrentPage-1) }}" class="Btn BtnSecondary">&laquo; قبلی</a>
      {% endif %}
      <span class="Pagination__info">صفحه {{ CurrentPage | persian_digits }} از {{ TotalPagesCount | persian_digits }}</span>
      {% if CurrentPage < TotalPagesCount %}
      <a href="{{ url_for('Admin.AdminClientsList', page=CurrentPage+1) }}" class="Btn BtnSecondary">بعدی &raquo;</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

{# "Add Client" Modal #}
<div id="addClientModal" class="Modal" aria-hidden="true">
  <div class="ModalContent">
    <button class="CloseBtn" data-dismiss="modal" aria-label="بستن">&times;</button>
    <h2 class="FormTitle">افزودن کاربر جدید</h2>
    <form action="{{ url_for('Admin.AdminAddClient') }}" method="POST" id="addClientForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="FormGroup">
        <label for="addEmail">ایمیل</label>
        <input type="email" id="addEmail" name="Email" required dir="ltr" class="FormControl" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="لطفا یک ایمیل معتبر وارد کنید" />
      </div>
      <div class="FormGroup">
        <label for="addPhone">شماره تلفن</label>
        <input type="tel" id="addPhone" name="PhoneNumber" required dir="ltr" class="FormControl" pattern="09[0-9]{9}" title="لطفا یک شماره تلفن معتبر وارد کنید (09xxxxxxxxx)" />
      </div>
      <div class="FormGroup">
        <label for="addPassword">رمز عبور موقت</label>
        <input type="password" id="addPassword" name="Password" required dir="ltr" class="FormControl" minlength="8" title="رمز عبور باید حداقل ۸ کاراکتر باشد" />
      </div>
      <div class="FormGroup">
        <button type="submit" class="Btn BtnPrimary Btn--fullWidth">
          <i class="fas fa-save"></i> ذخیره کاربر
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block Scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("ClientSearchInput");
    const clientsTable = document.getElementById("clients-table");
    const noResultsMessage = document.getElementById("NoResultsMessage");

    if (searchInput && clientsTable) {
      searchInput.addEventListener("input", function () {
        const searchTerm = this.value.toLowerCase().trim();
        const rows = clientsTable.querySelectorAll("tbody tr:not(.EmptyStateRow)");
        let hasResults = false;

        rows.forEach((row) => {
          const email = row.cells[1].textContent.toLowerCase();
          const phone = row.cells[2].textContent.toLowerCase();

          if (email.includes(searchTerm) || phone.includes(searchTerm)) {
            row.style.display = "";
            hasResults = true;
          } else {
            row.style.display = "none";
          }
        });

        noResultsMessage.style.display = hasResults ? "none" : "";
      });
    }

    if (typeof ModalHelpers !== "undefined") {
      ModalHelpers.init();
    }
  });
</script>
{% endblock %}