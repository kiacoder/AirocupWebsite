{% extends "global/base.html" %}

{% block title %}مدیریت کاربر: {{ client.email }} | پنل آیروکاپ{% endblock %}

{% block body %}
<div class="admin-page">
  <header class="admin-page__header">
    <div class="admin-page__title">
      <h1>مدیریت کاربر</h1>
      <p class="admin-page__subtitle">
        جزئیات حساب <strong dir="ltr">{{ client.email }}</strong> و تیم‌های ثبت‌شده توسط او را مدیریت کنید.
      </p>
    </div>
    <div class="admin-page__actions">
      <button class="btn btn-primary" data-modal-target="EditClientModal">
        <i class="fas fa-user-edit"></i>
        ویرایش حساب
      </button>
      <a
        href="{{ url_for('admin.admin_chat', client_id=client.client_id) }}"
        class="btn btn-secondary"
      >
        <i class="fas fa-comments"></i>
        گفتگو با کاربر
      </a>
      {% if client.status != enums.EntityStatus.ACTIVE %}
      <form
        method="POST"
        action="{{ url_for('admin.admin_restore_client', client_id=client.client_id) }}"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit" class="btn btn-success">
          <i class="fas fa-undo"></i>
          فعال‌سازی مجدد کاربر
        </button>
      </form>
      {% endif %}
    </div>
  </header>

  <section class="admin-page__section">
    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-id-card"></i> اطلاعات کاربری</h2>
          <p>مروری سریع بر اطلاعات تماس و وضعیت ثبت‌نام کاربر.</p>
        </div>
        <span class="admin-badge">
          <i class="fas fa-calendar-alt"></i>
          ثبت‌نام: {{ client.registration_date | formatdate | persian_digits }}
        </span>
      </header>
      <div class="admin-surface__body">
        <dl class="admin-info-list">
          <div>
            <dt>ایمیل</dt>
            <dd dir="ltr">{{ client.email }}</dd>
          </div>
          <div>
            <dt>شماره تماس</dt>
            <dd dir="ltr">{{ client.phone_number | persian_digits }}</dd>
          </div>
          <div>
            <dt>شناسه کاربر</dt>
            <dd>#{{ client.client_id | persian_digits }}</dd>
          </div>
          <div>
            <dt>وضعیت حساب</dt>
            <dd>
              <span class="admin-status admin-status--idle">
                {{ client.status.label if client.status else 'نامشخص' }}
              </span>
            </dd>
          </div>
          <div>
            <dt>تایید شماره همراه</dt>
            <dd>
              {% if client.is_phone_verified %}
              <span class="admin-badge admin-badge--success">تایید شده</span>
              {% else %}
              <span class="admin-badge admin-badge--muted">در انتظار تایید</span>
              {% endif %}
            </dd>
          </div>
          <div>
            <dt>تعداد تیم‌ها</dt>
            <dd>{{ teams|length | persian_digits }} تیم</dd>
          </div>
          <div>
            <dt>سطح تحصیلات</dt>
            <dd>{{ client.education_level or 'ثبت نشده' }}</dd>
          </div>
          <div>
            <dt>تاریخ ثبت‌نام</dt>
            <dd>{{ client.registration_date | formatdate | persian_digits }}</dd>
          </div>
        </dl>
      </div>
    </article>

    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-layer-group"></i> تیم‌های ثبت‌شده</h2>
          <p>مدیریت تیم‌ها، وضعیت پرداخت و دسترسی سریع به اعضا.</p>
        </div>
        <div class="admin-surface__actions">
          <button class="btn btn-primary" data-modal-target="AddTeamModal">
            <i class="fas fa-plus"></i>
            افزودن تیم جدید
          </button>
        </div>
      </header>

      <div class="admin-surface__body">
        <div class="admin-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>شناسه</th>
                <th>نام تیم</th>
                <th>تعداد اعضا</th>
                <th>وضعیت پرداخت</th>
                <th>جزئیات</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for team in teams %}
              {% set status_enum = team.last_payment_status %}
              {% set status_value = status_enum.value if status_enum else None %}
              <tr>
                <td>#{{ team.team_id | persian_digits }}</td>
                <td>{{ team.team_name }}</td>
                <td>{{ team.total_members | persian_digits }} نفر</td>
                <td>
                  <span
                    class="admin-status {% if status_value == 'approved' %}admin-status--approved{% elif status_value == 'pending' %}admin-status--pending{% elif status_value == 'rejected' %}admin-status--rejected{% else %}admin-status--idle{% endif %}"
                  >
                    <i class="fas fa-circle"></i>
                    {{ status_enum.label if status_enum else 'منتظر اقدام' }}
                  </span>
                </td>
                <td>
                  <div class="admin-meta-grid">
                    <span>تاریخ ایجاد: {{ team.team_registration_date | formatdate | persian_digits }}</span>
                    <span>مقطع: {{ team.education_level or '—' }}</span>
                    <span>لیگ اول: {{ team.league_one.name if team.league_one else '—' }}</span>
                    <span>لیگ دوم: {{ team.league_two.name if team.league_two else '—' }}</span>
                  </div>
                </td>
                <td class="admin-table__actions">
                  <a
                    href="{{ url_for('admin.admin_edit_team', team_id=team.team_id) }}"
                    class="btn btn-primary btn-small"
                  >
                    <i class="fas fa-clipboard-list"></i>
                    مدیریت تیم
                  </a>
                  <form
                    method="POST"
                    action="{{ url_for('admin.admin_delete_team', team_id=team.team_id) }}"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button
                      type="submit"
                      class="btn btn-danger btn-small delete-btn"
                      data-modal-title="تایید آرشیو تیم"
                      data-modal-body="آیا از آرشیو کردن تیم «{{ team.team_name }}» و تمام اعضای آن اطمینان دارید؟"
                      data-modal-confirm-text="بله، آرشیو کن"
                      data-modal-confirm-class="btn-danger"
                    >
                      <i class="fas fa-archive"></i>
                      آرشیو
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr class="admin-table__empty">
                <td colspan="5">
                  <div class="admin-empty-state">
                    <i class="fas fa-layer-group"></i>
                    این کاربر هنوز تیمی ایجاد نکرده است.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </article>

    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-archive"></i> تیم‌های آرشیو شده/غیرفعال</h2>
          <p>نمایش تیم‌هایی که به وضعیت غیرفعال یا منصرف شده منتقل شده‌اند.</p>
        </div>
      </header>

      <div class="admin-surface__body">
        <div class="admin-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>شناسه</th>
                <th>نام تیم</th>
                <th>تعداد اعضای ثبت شده</th>
                <th>آخرین وضعیت پرداخت</th>
                <th>جزئیات</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for team in archived_teams %}
              {% set status_enum = team.last_payment_status %}
              {% set status_value = status_enum.value if status_enum else None %}
              <tr>
                <td>#{{ team.team_id | persian_digits }}</td>
                <td>{{ team.team_name }}</td>
                <td>{{ team.total_members | persian_digits }} نفر</td>
                <td>
                  <span
                    class="admin-status {% if status_value == 'approved' %}admin-status--approved{% elif status_value == 'pending' %}admin-status--pending{% elif status_value == 'rejected' %}admin-status--rejected{% else %}admin-status--idle{% endif %}"
                  >
                    <i class="fas fa-circle"></i>
                    {{ status_enum.label if status_enum else 'بدون پرداخت' }}
                  </span>
                </td>
                <td>
                  <div class="admin-meta-grid">
                    <span>تاریخ ایجاد: {{ team.team_registration_date | formatdate | persian_digits }}</span>
                    <span>مقطع: {{ team.education_level or '—' }}</span>
                    <span>لیگ اول: {{ team.league_one.name if team.league_one else '—' }}</span>
                    <span>لیگ دوم: {{ team.league_two.name if team.league_two else '—' }}</span>
                    <span>وضعیت: {{ team.status.label if team.status else '—' }}</span>
                  </div>
                </td>
                <td>
                  <div class="admin-table__actions">
                    <a
                      href="{{ url_for('admin.admin_edit_team', team_id=team.team_id) }}"
                      class="btn btn-secondary btn-small"
                    >
                      مشاهده جزئیات
                    </a>
                    <form
                      method="POST"
                      action="{{ url_for('admin.admin_restore_team', team_id=team.team_id) }}"
                    >
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <button type="submit" class="btn btn-success btn-small">
                        <i class="fas fa-undo"></i>
                        بازگردانی تیم
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr class="admin-table__empty">
                <td colspan="6">
                  <div class="admin-empty-state">
                    <i class="fas fa-info-circle"></i>
                    تیم آرشیو شده‌ای برای این کاربر ثبت نشده است.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </article>

    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-receipt"></i> سوابق پرداخت</h2>
          <p>بررسی همه رسیدهای ارسال‌شده توسط کاربر، حتی پس از تایید یا رد.</p>
        </div>
      </header>
      <div class="admin-surface__body">
        <div class="admin-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>شناسه پرداخت</th>
                <th>تیم</th>
                <th>مبلغ</th>
                <th>تعداد اعضای پرداخت شده</th>
                <th>تاریخ بارگذاری</th>
                <th>وضعیت</th>
                <th>رسید</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments_history %}
              <tr>
                <td>#{{ payment.payment_id | persian_digits }}</td>
                <td>{{ payment.team_name }}</td>
                <td>{{ payment.amount | humanize_number | persian_digits }} ریال</td>
                <td>{{ payment.members_paid_for | persian_digits }} نفر</td>
                <td>{{ payment.upload_date | formatdate | persian_digits }}</td>
                <td>
                  <span
                    class="admin-status {% if payment.status.value == 'approved' %}admin-status--approved{% elif payment.status.value == 'pending' %}admin-status--pending{% else %}admin-status--rejected{% endif %}"
                  >
                    {{ payment.status.label if payment.status else 'نامشخص' }}
                  </span>
                </td>
                <td>
                  {% if payment.receipt_filename %}
                  <a
                    href="{{ url_for('uploaded_receipt_file', client_id=payment.client_id, filename=payment.receipt_filename) }}"
                    class="btn btn-secondary btn-small"
                    target="_blank"
                    rel="noopener"
                  >
                    مشاهده رسید
                  </a>
                  {% else %}-{% endif %}
                </td>
              </tr>
              {% else %}
              <tr class="admin-table__empty">
                <td colspan="7">
                  <div class="admin-empty-state">
                    <i class="fas fa-receipt"></i>
                    پرداختی برای این کاربر ثبت نشده است.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </article>
  </section>

  <footer class="admin-page__footer">
    <a href="{{ url_for('admin.admin_clients_list') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-right"></i>
      بازگشت به لیست کاربران
    </a>
  </footer>
</div>

<div
  id="EditClientModal"
  class="modal modal--admin"
  aria-hidden="true"
  role="dialog"
  aria-labelledby="editClientModalTitle"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <button class="modal-close" data-dismiss="modal" aria-label="بستن">&times;</button>
      <header class="modal-header">
        <h2 id="editClientModalTitle" class="modal-title">ویرایش حساب کاربر</h2>
      </header>
      <div class="modal-body">
        <form
          id="editClientForm"
          class="admin-form"
          method="POST"
          action="{{ url_for('admin.admin_edit_client', client_id=client.client_id) }}"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <div class="form-group">
            <label for="EditEmail">ایمیل</label>
            <input
              type="email"
              id="EditEmail"
              name="email"
              value="{{ client.email }}"
              required
              dir="ltr"
            />
          </div>

          <div class="form-group">
            <label for="EditPhone">شماره تلفن</label>
            <input
              type="tel"
              id="EditPhone"
              name="phone_number"
              value="{{ client.phone_number }}"
              required
              dir="ltr"
            />
          </div>

          <div class="form-group">
            <label for="EditPassword">رمز عبور جدید (اختیاری)</label>
            <div class="admin-input-group">
              <input
                type="password"
                id="EditPassword"
                name="password"
                placeholder="برای تغییر، رمز جدید را وارد کنید"
                dir="ltr"
              />
              <button
                type="button"
                class="btn btn-secondary"
                data-action="toggle-password"
                data-target="#EditPassword"
              >
                <i class="fas fa-eye-slash"></i>
              </button>
            </div>
            <p class="form-helper-text">در صورت خالی گذاشتن این فیلد، رمز عبور فعلی بدون تغییر باقی می‌ماند.</p>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              ذخیره تغییرات
            </button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              انصراف
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div
  id="AddTeamModal"
  class="modal modal--admin"
  aria-hidden="true"
  role="dialog"
  aria-labelledby="addTeamModalTitle"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <button class="modal-close" data-dismiss="modal" aria-label="بستن">&times;</button>
      <header class="modal-header">
        <h2 id="addTeamModalTitle" class="modal-title">افزودن تیم جدید برای {{ client.email }}</h2>
      </header>
      <div class="modal-body">
        <form
          id="addTeamForm"
          class="admin-form"
          method="POST"
          action="{{ url_for('admin.admin_add_team', client_id=client.client_id) }}"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <div class="form-group">
            <label for="AddTeamName">نام تیم</label>
            <input
              type="text"
              id="AddTeamName"
              name="TeamName"
              required
              maxlength="30"
            />
          </div>

          <div class="form-group">
            <label for="AddEducationLevel">مقطع تحصیلی تیم</label>
            <select id="AddEducationLevel" name="EducationLevel" required>
              <option value="">-- انتخاب مقطع --</option>
              {% for level_name, level_info in education_levels.items() %}
              {% set ages = level_info.get('ages') %}
              {% set age_label = '' %}
              {% if ages %}
                {% set age_min = ages[0] %}
                {% set age_max = ages[1] %}
                {% if age_min is not none and age_max is not none %}
                  {% set age_label = age_min | persian_digits ~ ' تا ' ~ age_max | persian_digits ~ ' سال' %}
                {% elif age_min is not none %}
                  {% set age_label = 'از ' ~ (age_min | persian_digits) ~ ' سال به بالا' %}
                {% elif age_max is not none %}
                  {% set age_label = 'تا ' ~ (age_max | persian_digits) ~ ' سال' %}
                {% endif %}
              {% endif %}
              <option value="{{ level_name }}">
                {{ level_name }}{% if age_label %} ({{ age_label }}){% endif %}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="AddLeagueOne">انتخاب لیگ اصلی</label>
            <select id="AddLeagueOne" name="LeagueOne" required>
              <option value="">-- انتخاب لیگ اول --</option>
              {% for league in leagues_list %}
              <option value="{{ league.id }}">{{ league.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="AddLeagueTwo">انتخاب لیگ دوم (اختیاری)</label>
            <select id="AddLeagueTwo" name="LeagueTwo">
              <option value="">-- بدون لیگ دوم --</option>
              {% for league in leagues_list %}
              <option value="{{ league.id }}">{{ league.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              ایجاد تیم
            </button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              انصراف
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
