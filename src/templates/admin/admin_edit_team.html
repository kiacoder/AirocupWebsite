{% extends "global/base.html" %}

{% block title %}مدیریت تیم: {{ team.team_name }} | پنل آیروکاپ{% endblock %}

{% block body %}
<div class="admin-page admin-edit-team-page" data-team-id="{{ team.team_id }}">
  <header class="admin-page__header">
    <div class="admin-page__title">
      <h1>مدیریت تیم «{{ team.team_name }}»</h1>
      <p class="admin-page__subtitle">
        اطلاعات تیم، لیگ‌های فعال، وضعیت پرداخت و اعضای ثبت‌شده را از این بخش کنترل کنید.
      </p>
    </div>
    <div class="admin-page__actions admin-page__meta">
      <div class="admin-page__meta-item">
        <span>شناسه تیم</span>
        <strong>#{{ team.team_id | persian_digits }}</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>لیگ اصلی</span>
        <strong>{{ team.league_one.name if team.league_one else 'ثبت نشده' }}</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>لیگ دوم</span>
        <strong>{{ team.league_two.name if team.league_two else 'انتخاب نشده' }}</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>اعضای ثبت‌شده</span>
        <strong>{{ members|length | persian_digits }} نفر</strong>
      </div>
    </div>
  </header>

  <section class="admin-page__section">
    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-edit"></i> اطلاعات و لیگ‌ها</h2>
          <p>نام تیم و لیگ‌های منتخب را ویرایش کنید.</p>
        </div>
      </header>
      <div class="admin-surface__body">
        <form
          method="POST"
          action="{{ url_for('admin.admin_edit_team', team_id=team.team_id) }}"
          id="teamForm"
          class="admin-form"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <div class="form-group">
            <label for="team_name">نام تیم *</label>
            <input
              type="text"
              id="team_name"
              name="team_name"
              value="{{ team.team_name }}"
              required
              maxlength="30"
            />
          </div>

          <div class="form-grid form-grid--two">
            <div class="form-group">
              <label for="league_one_id">لیگ اول (اجباری) *</label>
              <select id="league_one_id" name="league_one_id" required>
                <option value="">-- انتخاب لیگ اول --</option>
                {% for league in leagues_list %}
                <option value="{{ league.id }}" {% if league.id == team.league_one_id %}selected{% endif %}>
                  {{ league.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="league_two_id">لیگ دوم (اختیاری)</label>
              <select id="league_two_id" name="league_two_id">
                <option value="">-- بدون لیگ دوم --</option>
                {% for league in leagues_list %}
                <option value="{{ league.id }}" {% if league.id == team.league_two_id %}selected{% endif %}>
                  {{ league.name }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              ذخیره اطلاعات تیم
            </button>
            <a
              href="{{ url_for('admin.admin_manage_client', client_id=team.client_id) }}"
              class="btn btn-secondary"
            >
              بازگشت به صفحه کاربر
            </a>
          </div>
        </form>
      </div>
    </article>

    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-users"></i> مدیریت اعضا</h2>
          <p>ویرایش اطلاعات اعضای تیم یا افزودن عضو جدید.</p>
        </div>
        <div class="admin-surface__actions">
          <a
            href="{{ url_for('admin.admin_add_member', team_id=team.team_id) }}"
            class="btn btn-primary"
          >
            <i class="fas fa-user-plus"></i>
            افزودن عضو جدید
          </a>
        </div>
      </header>
      <div class="admin-surface__body">
        <div class="admin-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>نام عضو</th>
                <th>نقش</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for member in members %}
              <tr>
                <td>{{ member.name }}</td>
                <td>
                  <span class="admin-status admin-status--idle">
                    <i class="fas fa-user-tag"></i>
                    {{ member.role.label if member.role else 'نامشخص' }}
                  </span>
                </td>
                <td class="admin-table__actions">
                  <button
                    type="button"
                    class="btn btn-secondary btn-small"
                    data-modal-target="editMemberModal"
                    data-member-id="{{ member.member_id }}"
                    data-name="{{ member.name }}"
                    data-national-id="{{ member.national_id }}"
                    data-role="{{ member.role.value if member.role else '' }}"
                    data-province="{{ member.city.province.name if member.city and member.city.province else '' }}"
                    data-city="{{ member.city.name if member.city else '' }}"
                    data-birth-date="{{ member.birth_date | formatdate }}"
                  >
                    <i class="fas fa-edit"></i>
                    ویرایش
                  </button>
                  <form
                    method="POST"
                    action="{{ url_for('admin.admin_delete_member', team_id=team.team_id, member_id=member.member_id) }}"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button
                      type="submit"
                      class="btn btn-danger btn-small delete-btn"
                      data-modal-title="تایید حذف عضو"
                      data-modal-body="آیا از حذف عضو «{{ member.name }}» اطمینان دارید؟"
                      data-modal-confirm-text="بله، حذف کن"
                      data-modal-confirm-class="btn-danger"
                    >
                      <i class="fas fa-trash"></i>
                      حذف
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr class="admin-table__empty">
                <td colspan="3">
                  <div class="admin-empty-state">
                    <i class="fas fa-users"></i>
                    هنوز عضوی برای این تیم ثبت نشده است.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </article>
  </section>
</div>

<div
  id="editMemberModal"
  class="modal modal--admin"
  aria-hidden="true"
  role="dialog"
  aria-labelledby="editMemberModalTitle"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-content--wide">
      <button class="modal-close" data-dismiss="modal" aria-label="بستن">&times;</button>
      <header class="modal-header">
        <h2 id="editMemberModalTitle" class="modal-title">ویرایش عضو</h2>
      </header>
      <div class="modal-body">
        <form id="MemberForm" method="POST" action="" class="admin-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          {% with
              id_prefix='Modal-',
              provinces=Provinces,
              persian_months=PersianMonths,
              allowed_years=AllowedYears
          %}
            {% include 'client/member_form_fields.html' %}
          {% endwith %}
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              ذخیره تغییرات
            </button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              انصراف
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
