{% extends "global/base.html" %}

{% block title %}مدیریت تیم: {{ team.team_name }} | پنل آیروکاپ{% endblock %}

{% block body %}
<div class="Container AdminMembersPage" data-team-id="{{ team.team_id }}">
  <div class="PageHeader">
    <h1 class="SectionTitle">مدیریت تیم: {{ team.team_name }}</h1>
    <p class="FormSubtitle">
      اطلاعات، پرداخت، لیگ‌ها و اعضای این تیم را مدیریت کنید.
    </p>
  </div>

  <div class="PageGrid PageGrid--2">
    <div>
      <div class="Card">
        <h2 class="Card__header"><i class="fas fa-edit"></i> اطلاعات و لیگ‌ها</h2>
        <div class="Card__body" style="padding: 1.5rem;">
          <form method="POST" action="{{ url_for('admin.admin_edit_team', team_id=team.team_id) }}" id="teamForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="FormGroup">
              <label for="team_name" class="FormLabel">نام تیم *</label>
              <input type="text" id="team_name" name="team_name" value="{{ team.team_name }}" required class="FormControl" maxlength="30" />
            </div>
            <div class="FormGroup">
              <label for="league_one_id" class="FormLabel">لیگ اول (اجباری) *</label>
              <select id="league_one_id" name="league_one_id" required class="FormControl">
                <option value="">-- انتخاب لیگ اول --</option>
                {% for league in leagues_list %}
                <option value="{{ league.id }}" {% if league.id == team.league_one_id %}selected{% endif %}>{{ league.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="FormGroup">
              <label for="league_two_id" class="FormLabel">لیگ دوم (اختیاری)</label>
              <select id="league_two_id" name="league_two_id" class="FormControl">
                <option value="">-- بدون لیگ دوم --</option>
                {% for league in leagues_list %}
                <option value="{{ league.id }}" {% if league.id == team.league_two_id %}selected{% endif %}>{{ league.name }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="Btn BtnPrimary Btn--fullWidth"><i class="fas fa-save"></i> ذخیره اطلاعات</button>
          </form>
        </div>
      </div>
    </div>

    <div>
      <div class="Card Card--table">
        <h2 class="Card__header">
          <i class="fas fa-users"></i> مدیریت اعضا
          <a href="{{ url_for('admin.admin_add_member', team_id=team.team_id) }}" class="Btn BtnPrimary"><i class="fas fa-plus"></i> افزودن عضو</a>
        </h2>
        <div class="UserTableWrapper">
          <table class="UserTable">
            <thead>
              <tr>
                <th>نام عضو</th>
                <th>نقش</th>
                <th class="ActionsHeader">عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for member in members %}
              <tr>
                <td>{{ member.name }}</td>
                <td>
                  <span class="Badge Badge--primary">{{ member.role.label if member.role else 'نامشخص' }}</span>
                </td>
                <td class="Actions">
                  <button type="button" class="Btn BtnSecondary BtnSmall EditBtn"
                          data-modal-target="MemberModal"
                          data-member-id="{{ member.member_id }}"
                          data-name="{{ member.name }}"
                          data-national-id="{{ member.national_id }}"
                          data-role="{{ member.role.value if member.role else '' }}"
                          data-province-name="{{ member.city.province.name if member.city and member.city.province else '' }}"
                          data-city-name="{{ member.city.name if member.city else '' }}"
                          data-birth-date="{{ member.birth_date | formatdate }}">
                    <i class="fas fa-edit"></i> ویرایش
                  </button>
                  <form method="POST" action="{{ url_for('admin.admin_delete_member', team_id=team.team_id, member_id=member.member_id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="button" class="Btn BtnDanger BtnSmall DeleteBtn" data-modal-title="تایید حذف عضو" data-modal-text="آیا از حذف عضو «{{ member.name }}» اطمینان دارید؟" data-modal-confirm="بله، حذف کن">
                      <i class="fas fa-trash"></i> حذف
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr class="EmptyStateRow">
                <td colspan="3" class="EmptyState">هنوز عضوی برای این تیم ثبت نشده است.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="SectionCta">
    <a href="{{ url_for('admin.admin_manage_client', client_id=team.client_id) }}" class="Btn BtnSecondary"><i class="fas fa-arrow-left"></i> بازگشت به صفحه کاربر</a>
  </div>
</div>

<div id="MemberModal" class="Modal" aria-hidden="true">
  <div class="ModalContent ModalContent--large">
    <button class="CloseBtn" data-dismiss="modal" aria-label="بستن">&times;</button>
    <h2 class="FormTitle" id="MemberModalTitle">ویرایش عضو</h2>
    <form id="MemberForm" method="POST" action="">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      {% with
          id_prefix='Modal-',
          provinces=Provinces,
          persian_months=PersianMonths,
          allowed_years=AllowedYears
      %}
        {% include 'client/member_form_fields.html' %}
      {% endwith %}
      <div class="FormGroup" style="margin-top: 2rem;">
        <button type="submit" class="Btn BtnPrimary Btn--fullWidth"><i class="fas fa-save"></i> ذخیره تغییرات</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const page = document.querySelector('.AdminMembersPage');
    if (!page) {
      return;
    }

    const teamId = page.dataset.teamId;
    const modalForm = document.getElementById('MemberForm');

    document.querySelectorAll('.EditBtn').forEach((button) => {
      button.addEventListener('click', function () {
        const memberId = this.dataset.memberId;
        modalForm.action = `/Admin/Team/${teamId}/EditMember/${memberId}`;

        modalForm.elements.name.value = this.dataset.name || '';
        modalForm.elements.national_id.value = this.dataset.nationalId || '';
        modalForm.elements.role.value = this.dataset.role || '';

        const birthDate = (this.dataset.birthDate || '').split('-');
        modalForm.elements.birth_year.value = birthDate[0] || '';
        modalForm.elements.birth_month.value = birthDate[1] || '';
        modalForm.elements.birth_day.value = birthDate[2] || '';

        const provinceSelect = modalForm.elements.province;
        const citySelect = modalForm.elements.city;
        const provinceName = this.dataset.provinceName || '';
        const cityName = this.dataset.cityName || '';

        if (typeof FormHelpers !== 'undefined') {
          FormHelpers.PopulateProvinces(provinceSelect);
          provinceSelect.value = provinceName;
          FormHelpers.SetupProvinceCityListener(modalForm);
          if (provinceSelect && typeof provinceSelect.dispatchEvent === 'function') {
            provinceSelect.dispatchEvent(new Event('change'));
          }
          citySelect.value = cityName;
        } else {
          provinceSelect.value = provinceName;
          citySelect.value = cityName;
        }

        if (typeof ModalHelpers !== 'undefined') {
          ModalHelpers.openModal('MemberModal');
        }
      });
    });

    if (typeof ModalHelpers !== 'undefined') {
      ModalHelpers.init();
    }
    if (typeof FormHelpers !== 'undefined') {
      FormHelpers.SetupDatePicker(modalForm);
      FormHelpers.SetupProvinceCityListener(modalForm);
      document.querySelectorAll('.DeleteBtn').forEach((btn) => {
        btn.addEventListener('click', function () {
          FormHelpers.showConfirmModal(
            this.dataset.modalTitle,
            this.dataset.modalText,
            this.dataset.modalConfirm,
            () => this.closest('form').submit()
          );
        });
      });
    }
  });
</script>
{% endblock %}
