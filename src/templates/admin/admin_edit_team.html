{% extends "global/base.html" %}

{% block title %}مدیریت تیم: {{ team.team_name }} | پنل آیروکاپ{% endblock %}

{% block body %}
<div class="admin-page admin-edit-team-page" data-team-id="{{ team.team_id }}">
  <header class="admin-page__header">
    <div class="admin-page__title">
      <h1>مدیریت تیم «{{ team.team_name }}»</h1>
      <p class="admin-page__subtitle">
        اطلاعات تیم، لیگ‌های فعال، وضعیت پرداخت و اعضای ثبت‌شده را از این بخش کنترل کنید.
      </p>
    </div>
    <div class="admin-page__actions admin-page__meta">
      <div class="admin-page__meta-item">
        <span>شناسه تیم</span>
        <strong>#{{ team.team_id | persian_digits }}</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>لیگ اصلی</span>
        <strong>{{ team.league_one.name if team.league_one else 'ثبت نشده' }}</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>لیگ دوم</span>
        <strong>{{ team.league_two.name if team.league_two else 'انتخاب نشده' }}</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>اعضای ثبت‌شده</span>
        <strong>{{ members|length | persian_digits }} نفر</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>وضعیت تیم</span>
        <strong>{{ team.status.label if team.status else 'نامشخص' }}</strong>
      </div>
      <div class="admin-page__meta-item">
        <span>اعضای پرداخت‌نشده</span>
        <strong>{{ team.unpaid_members_count | default(0, true) | persian_digits }} نفر</strong>
      </div>
    </div>
  </header>

  <section class="admin-page__section">
    <div class="admin-page__stats">
      <div class="admin-badge admin-badge--muted">
        <i class="fas fa-calendar-day"></i>
        ثبت: {{ team.team_registration_date | formatdate | persian_digits }}
      </div>
      <div class="admin-badge admin-badge--info">
        <i class="fas fa-user-clock"></i>
        میانگین سن: {{ team.average_age | default(0, true) | persian_digits }} سال
      </div>
      <div class="admin-badge admin-badge--info">
        <i class="fas fa-map"></i>
        استان/شهر: {{ team.average_provinces or '—' }}
      </div>
      <div class="admin-badge">
        <i class="fas fa-receipt"></i>
        آخرین پرداخت:
        {% if last_payment %}
        {{ last_payment.status.label if last_payment.status else 'نامشخص' }} — {{ last_payment.upload_date | formatdate | persian_digits }}
        {% else %}
        ثبت نشده
        {% endif %}
      </div>
    </div>

    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-edit"></i> اطلاعات و لیگ‌ها</h2>
          <p>نام تیم و لیگ‌های منتخب را ویرایش کنید.</p>
        </div>
      </header>
      <div class="admin-surface__body">
        <form
          method="POST"
          action="{{ url_for('admin.admin_edit_team', team_id=team.team_id) }}"
          id="teamForm"
          class="admin-form"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <div class="form-group">
            <label for="team_name">نام تیم *</label>
            <input
              type="text"
              id="team_name"
              name="team_name"
              value="{{ team.team_name }}"
              required
              maxlength="30"
            />
          </div>

          <div class="form-group">
            <label for="education_level">مقطع تحصیلی تیم *</label>
            <select id="education_level" name="education_level" required>
              <option value="">-- انتخاب مقطع --</option>
              {% for level_name, level_info in education_levels.items() %}
              {% set ages = level_info.get('ages') %}
              {% set age_label = '' %}
              {% if ages %}
                {% set age_min = ages[0] %}
                {% set age_max = ages[1] %}
                {% if age_min is not none and age_max is not none %}
                  {% set age_label = age_min | persian_digits ~ ' تا ' ~ age_max | persian_digits ~ ' سال' %}
                {% elif age_min is not none %}
                  {% set age_label = 'از ' ~ (age_min | persian_digits) ~ ' سال به بالا' %}
                {% elif age_max is not none %}
                  {% set age_label = 'تا ' ~ (age_max | persian_digits) ~ ' سال' %}
                {% endif %}
              {% endif %}
              <option
                value="{{ level_name }}"
                {% if team.education_level == level_name %}selected{% endif %}
              >
                {{ level_name }}{% if age_label %} ({{ age_label }}){% endif %}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-grid form-grid--two">
            <div class="form-group">
              <label for="league_one_id">لیگ اول (اجباری) *</label>
              <select id="league_one_id" name="league_one_id" required>
                <option value="">-- انتخاب لیگ اول --</option>
                {% for league in leagues_list %}
                <option value="{{ league.id }}" {% if league.id == team.league_one_id %}selected{% endif %}>
                  {{ league.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="league_two_id">لیگ دوم (اختیاری)</label>
              <select id="league_two_id" name="league_two_id">
                <option value="">-- بدون لیگ دوم --</option>
                {% for league in leagues_list %}
                <option value="{{ league.id }}" {% if league.id == team.league_two_id %}selected{% endif %}>
                  {{ league.name }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              ذخیره اطلاعات تیم
            </button>
            <a
              href="{{ url_for('admin.admin_manage_client', client_id=team.client_id) }}"
              class="btn btn-secondary"
            >
              بازگشت به صفحه کاربر
            </a>
          </div>
        </form>
      </div>
    </article>

    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-users"></i> مدیریت اعضا</h2>
          <p>ویرایش اطلاعات اعضای تیم یا افزودن عضو جدید.</p>
        </div>
        <div class="admin-surface__actions">
          <a
            href="{{ url_for('admin.admin_add_member', team_id=team.team_id) }}"
            class="btn btn-primary"
          >
            <i class="fas fa-user-plus"></i>
            افزودن عضو جدید
          </a>
        </div>
      </header>
      <div class="admin-surface__body">
        <div class="admin-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>نام عضو</th>
                <th>نقش</th>
                <th>کد ملی</th>
                <th>محل سکونت</th>
                <th>تاریخ تولد</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for member in members %}
              <tr>
                <td>{{ member.name }}</td>
                <td>
                  <span class="admin-status admin-status--idle">
                    <i class="fas fa-user-tag"></i>
                    {{ member.role.label if member.role else 'نامشخص' }}
                  </span>
                </td>
                <td dir="ltr">{{ member.national_id }}</td>
                <td>
                  {{ member.city.province.name if member.city and member.city.province else '—' }}
                  {% if member.city and member.city.name %} | {{ member.city.name }}{% endif %}
                </td>
                <td>{{ member.birth_date | formatdate | persian_digits }}</td>
                <td class="admin-table__actions">
                  <button
                    type="button"
                    class="btn btn-secondary btn-small"
                    data-modal-target="editMemberModal"
                    data-member-id="{{ member.member_id }}"
                    data-name="{{ member.name }}"
                    data-national-id="{{ member.national_id }}"
                    data-role="{{ member.role.value if member.role else '' }}"
                    data-province="{{ member.city.province.name if member.city and member.city.province else '' }}"
                    data-city="{{ member.city.name if member.city else '' }}"
                    data-birth-date="{{ member.birth_date | formatdate }}"
                  >
                    <i class="fas fa-edit"></i>
                    ویرایش
                  </button>
                  <form
                    method="POST"
                    action="{{ url_for('admin.admin_delete_member', team_id=team.team_id, member_id=member.member_id) }}"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button
                      type="submit"
                      class="btn btn-danger btn-small delete-btn"
                      data-modal-title="تایید حذف عضو"
                      data-modal-body="آیا از حذف عضو «{{ member.name }}» اطمینان دارید؟"
                      data-modal-confirm-text="بله، حذف کن"
                      data-modal-confirm-class="btn-danger"
                    >
                      <i class="fas fa-trash"></i>
                      حذف
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr class="admin-table__empty">
                <td colspan="6">
                  <div class="admin-empty-state">
                    <i class="fas fa-users"></i>
                    هنوز عضوی برای این تیم ثبت نشده است.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </article>

    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-wallet"></i> سوابق پرداخت تیم</h2>
          <p>همه رسیدها و وضعیت‌های مربوط به این تیم.</p>
        </div>
      </header>
      <div class="admin-surface__body">
        <div class="admin-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>شناسه پرداخت</th>
                <th>مبلغ</th>
                <th>اعضای پرداخت شده</th>
                <th>تاریخ بارگذاری</th>
                <th>وضعیت</th>
                <th>رسید</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments %}
              <tr>
                <td>#{{ payment.payment_id | persian_digits }}</td>
                <td>{{ payment.amount | humanize_number | persian_digits }} ریال</td>
                <td>{{ payment.members_paid_for | persian_digits }} نفر</td>
                <td>{{ payment.upload_date | formatdate | persian_digits }}</td>
                <td>
                  <span
                    class="admin-status {% if payment.status.value == 'approved' %}admin-status--approved{% elif payment.status.value == 'pending' %}admin-status--pending{% else %}admin-status--rejected{% endif %}"
                  >
                    {{ payment.status.label if payment.status else 'نامشخص' }}
                  </span>
                </td>
                <td>
                  {% if payment.receipt_filename %}
                  <a
                    href="{{ url_for('uploaded_receipt_file', client_id=payment.client_id, filename=payment.receipt_filename) }}"
                    class="btn btn-secondary btn-small"
                    target="_blank"
                    rel="noopener"
                  >
                    مشاهده رسید
                  </a>
                  {% else %}-{% endif %}
                </td>
              </tr>
              {% else %}
              <tr class="admin-table__empty">
                <td colspan="6">
                  <div class="admin-empty-state">
                    <i class="fas fa-receipt"></i>
                    پرداختی برای این تیم ثبت نشده است.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </article>
  </section>
</div>

<div
  id="editMemberModal"
  class="modal modal--admin"
  aria-hidden="true"
  role="dialog"
  aria-labelledby="editMemberModalTitle"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-content--wide">
      <button class="modal-close" data-dismiss="modal" aria-label="بستن">&times;</button>
      <header class="modal-header">
        <h2 id="editMemberModalTitle" class="modal-title">ویرایش عضو</h2>
      </header>
      <div class="modal-body">
        <form id="MemberForm" method="POST" action="" class="admin-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          {% with
              id_prefix='Modal-',
              provinces=Provinces,
              persian_months=PersianMonths,
              allowed_years=AllowedYears
          %}
            {% include 'client/member_form_fields.html' %}
          {% endwith %}
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              ذخیره تغییرات
            </button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              انصراف
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
