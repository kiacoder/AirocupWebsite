{% extends "global/base.html" %}

{% block title %}مدیریت تیم: {{ Team.TeamName }} | پنل آیروکاپ{% endblock %}

{% block body %}
<div class="Container AdminMembersPage" data-team-id="{{ Team.TeamID }}">
  <div class="PageHeader">
    <h1 class="SectionTitle">مدیریت تیم: {{ Team.TeamName }}</h1>
    <p class="FormSubtitle">
      اطلاعات، پرداخت، لیگ‌ها و اعضای این تیم را مدیریت کنید.
    </p>
  </div>

  <div class="PageGrid PageGrid--2">
    <div>
      <div class="Card">
        <h2 class="Card__header"><i class="fas fa-edit"></i> اطلاعات و لیگ‌ها</h2>
        <div class="Card__body" style="padding: 1.5rem;">
          <form method="POST" action="{{ url_for('Admin.AdminEditTeam', TeamID=Team.TeamID) }}" id="teamForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="FormGroup">
              <label for="TeamName" class="FormLabel">نام تیم *</label>
              <input type="text" id="TeamName" name="TeamName" value="{{ Team.TeamName }}" required class="FormControl" maxlength="30" />
            </div>
            <div class="FormGroup">
              <label for="LeagueOneID" class="FormLabel">لیگ اول (اجباری) *</label>
              <select id="LeagueOneID" name="LeagueOneID" required class="FormControl">
                <option value="">-- انتخاب لیگ اول --</option>
                {% for league in LeaguesList %}
                <option value="{{ league.ID }}" {% if league.ID == Team.LeagueOneID %}selected{% endif %}>{{ league.Name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="FormGroup">
              <label for="LeagueTwoID" class="FormLabel">لیگ دوم (اختیاری)</label>
              <select id="LeagueTwoID" name="LeagueTwoID" class="FormControl">
                <option value="">-- بدون لیگ دوم --</option>
                {% for league in LeaguesList %}
                <option value="{{ league.ID }}" {% if league.ID == Team.LeagueTwoID %}selected{% endif %}>{{ league.Name }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="Btn BtnPrimary Btn--fullWidth"><i class="fas fa-save"></i> ذخیره اطلاعات</button>
          </form>
        </div>
      </div>
    </div>

    <div>
      <div class="Card Card--table">
        <h2 class="Card__header">
          <i class="fas fa-users"></i> مدیریت اعضا
          <a href="{{ url_for('Admin.AdminAddMember', TeamID=Team.TeamID) }}" class="Btn BtnPrimary"><i class="fas fa-plus"></i> افزودن عضو</a>
        </h2>
        <div class="UserTableWrapper">
          <table class="UserTable">
            <thead>
              <tr>
                <th>نام عضو</th>
                <th>نقش</th>
                <th class="ActionsHeader">عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for member in Members %}
              <tr>
                <td>{{ member.Name }}</td>
                <td>
                  <span class="Badge Badge--primary">{{ member.Role.label }}</span>
                </td>
                <td class="Actions">
                  <button type="button" class="Btn BtnSecondary BtnSmall EditBtn" 
                          data-modal-target="MemberModal"
                          data-member-id="{{ member.MemberID }}"
                          data-name="{{ member.Name }}"
                          data-national-id="{{ member.NationalID }}"
                          data-role="{{ member.Role.value }}"
                          data-city-id="{{ member.CityID }}"
                          data-birth-date="{{ member.BirthDate | formatdate }}">
                    <i class="fas fa-edit"></i> ویرایش
                  </button>
                  <form method="POST" action="{{ url_for('Admin.AdminDeleteMember', TeamID=Team.TeamID, MemberID=member.MemberID) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="button" class="Btn BtnDanger BtnSmall DeleteBtn" data-modal-title="تایید حذف عضو" data-modal-text="آیا از حذف عضو «{{ member.Name }}» اطمینان دارید؟" data-modal-confirm="بله، حذف کن">
                      <i class="fas fa-trash"></i> حذف
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr class="EmptyStateRow">
                <td colspan="3" class="EmptyState">هنوز عضوی برای این تیم ثبت نشده است.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="SectionCta">
    <a href="{{ url_for('Admin.AdminManageClient', ClientID=Team.ClientID) }}" class="Btn BtnSecondary"><i class="fas fa-arrow-left"></i> بازگشت به صفحه کاربر</a>
  </div>
</div>

<div id="MemberModal" class="Modal" aria-hidden="true">
  <div class="ModalContent ModalContent--large">
    <button class="CloseBtn" data-dismiss="modal" aria-label="بستن">&times;</button>
    <h2 class="FormTitle" id="MemberModalTitle">ویرایش عضو</h2>
    <form id="MemberForm" method="POST" action="">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      {% with 
          IdPrefix='Modal-',
          Provinces=Provinces,
          PersianMonths=PersianMonths,
          AllowedYears=AllowedYears,
          DaysInMonth=DaysInMonth
      %} 
        {% include 'Client/MemberFormFields.html' %} 
      {% endwith %}
      <div class="FormGroup" style="margin-top: 2rem;">
        <button type="submit" class="Btn BtnPrimary Btn--fullWidth"><i class="fas fa-save"></i> ذخیره تغییرات</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const teamId = document.querySelector('.AdminMembersPage').dataset.teamId;

      document.querySelectorAll('.EditBtn').forEach(button => {
          button.addEventListener('click', function () {
              const memberId = this.dataset.memberId;
              const form = document.getElementById('MemberForm');
              form.action = `/Admin/Team/${teamId}/EditMember/${memberId}`;

              document.getElementById('MemberModalTitle').textContent = 'ویرایش عضو';
              document.getElementById('Modal-Name').value = this.dataset.name;
              document.getElementById('Modal-NationalID').value = this.dataset.nationalId;
              document.getElementById('Modal-Role').value = this.dataset.role;

              const birthDate = this.dataset.birthDate.split('-');
              if (birthDate.length === 3) {
                  document.getElementById('Modal-BirthYear').value = birthDate[0];
                  document.getElementById('Modal-BirthMonth').value = birthDate[1];
                  document.getElementById('Modal-BirthDay').value = birthDate[2];
              }

              // You'll need a way to get Province from CityID if not directly available
              // This is a placeholder for that logic
              const cityId = this.dataset.cityId;
              // Find province and city from cityId and populate selects...

              if (typeof ModalHelpers !== "undefined") {
                  ModalHelpers.openModal('MemberModal');
              }
          });
      });

      if (typeof ModalHelpers !== "undefined") {
          ModalHelpers.init();
      }
      if (typeof FormHelpers !== "undefined") {
          const modalForm = document.getElementById('MemberForm');
          FormHelpers.PopulateProvinces(modalForm.querySelector('[name="Province"]'));
          FormHelpers.SetupDatePicker(modalForm);
          FormHelpers.SetupProvinceCityListener(modalForm);
          document.querySelectorAll('.DeleteBtn').forEach(btn => {
            btn.addEventListener('click', function() {
                FormHelpers.showConfirmModal(this.dataset.modalTitle, this.dataset.modalText, this.dataset.modalConfirm, () => {
                    this.closest('form').submit();
                });
            });
          });
      }
  });
</script>
{% endblock %}