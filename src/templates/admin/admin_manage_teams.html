{% extends "global/base.html" %}

{% block title %}مدیریت جامع تیم‌ها | پنل آیروکاپ{% endblock %}

{% block body %}
<div class="admin-page">
  <header class="admin-page__header">
    <div class="admin-page__title">
      <h1>مدیریت جامع تیم‌ها</h1>
      <p class="admin-page__subtitle">
        تمام تیم‌های فعال در سامانه را مشاهده کنید، وضعیت پرداخت‌ها را بررسی کنید و به صفحه مدیریت اختصاصی هر تیم دسترسی پیدا کنید.
      </p>
    </div>
    <div class="admin-page__actions">
      <span class="admin-badge">
        <i class="fas fa-users"></i>
        {{ teams|length | persian_digits }} تیم
      </span>
    </div>
  </header>

  <section class="admin-page__section">
    <article class="admin-surface">
      <header class="admin-surface__header">
        <div class="admin-surface__title">
          <h2><i class="fas fa-layer-group"></i> لیست تیم‌ها</h2>
          <p>خلاصه‌ای از آخرین وضعیت تیم‌ها به‌همراه اطلاعات مالک و آخرین پرداخت.</p>
        </div>
      </header>
      <div class="admin-surface__body">
        <form class="admin-search-form" method="GET" action="{{ url_for('admin.admin_manage_teams') }}">
          <div class="form-grid">
            <div class="form-group">
              <label for="q">کلمه کلیدی</label>
              <input
                type="search"
                id="q"
                name="q"
                value="{{ keyword or '' }}"
                placeholder="نام تیم"
              />
            </div>
            <div class="form-group">
              <label for="status">وضعیت</label>
              <select id="status" name="status">
                <option value="active" {% if status_filter=='active' %}selected{% endif %}>فقط فعال</option>
                <option value="archived" {% if status_filter=='archived' %}selected{% endif %}>فقط آرشیو شده</option>
                <option value="all" {% if status_filter=='all' %}selected{% endif %}>همه</option>
              </select>
            </div>
            <div class="form-group">
              <label for="payment_status">آخرین وضعیت پرداخت</label>
              <select id="payment_status" name="payment_status">
                <option value="">همه</option>
                {% for status in enums.PaymentStatus %}
                <option value="{{ status.name }}" {% if payment_filter==status.name %}selected{% endif %}>{{ status.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="sort">مرتب‌سازی</label>
              <select id="sort" name="sort">
                <option value="recent" {% if sort_option=='recent' %}selected{% endif %}>جدیدترین</option>
                <option value="oldest" {% if sort_option=='oldest' %}selected{% endif %}>قدیمی‌ترین</option>
                <option value="name_asc" {% if sort_option=='name_asc' %}selected{% endif %}>نام (صعودی)</option>
                <option value="name_desc" {% if sort_option=='name_desc' %}selected{% endif %}>نام (نزولی)</option>
                <option value="members_desc" {% if sort_option=='members_desc' %}selected{% endif %}>بیشترین عضو</option>
              </select>
            </div>
          </div>
          <div class="admin-search-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-filter"></i>
              اعمال فیلتر
            </button>
            <a href="{{ url_for('admin.admin_manage_teams') }}" class="btn btn-secondary">پاک کردن</a>
          </div>
        </form>
        <div class="admin-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>نام تیم</th>
                <th>کاربر مالک</th>
                <th>تعداد اعضا</th>
                <th>آخرین وضعیت پرداخت</th>
                <th>وضعیت</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for team in teams %}
              {% set status_enum = team.last_payment_status %}
              {% set status_value = status_enum.value if status_enum else None %}
              <tr>
                <td>
                  <strong>{{ team.team_name }}</strong><br />
                  <small class="admin-page__lead">کد تیم: #{{ team.team_id | persian_digits }}</small>
                </td>
                <td>{{ team.client_email }}</td>
                <td>{{ team.member_count | persian_digits }} نفر</td>
                <td>
                  <span
                    class="admin-status {% if status_value == 'approved' %}admin-status--approved{% elif status_value == 'pending' %}admin-status--pending{% elif status_value == 'rejected' %}admin-status--rejected{% else %}admin-status--idle{% endif %}"
                  >
                    <i class="fas fa-circle"></i>
                    {{ status_enum.label if status_enum else 'منتظر اقدام' }}
                  </span>
                </td>
                <td>{{ team.status.label if team.status else '—' }}</td>
                <td class="admin-table__actions">
                  <a
                    href="{{ url_for('admin.admin_edit_team', team_id=team.team_id) }}"
                    class="btn btn-primary btn-small"
                    title="مدیریت کامل تیم"
                  >
                    <i class="fas fa-edit"></i>
                    مدیریت تیم
                  </a>
                  {% if team.status and team.status != enums.EntityStatus.ACTIVE %}
                  <form method="POST" action="{{ url_for('admin.admin_restore_team', team_id=team.team_id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit" class="btn btn-success btn-small">
                      <i class="fas fa-undo"></i>
                      بازگردانی
                    </button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr class="admin-table__empty">
                <td colspan="6">
                  <div class="admin-empty-state">
                    <i class="fas fa-layer-group"></i>
                    هیچ تیمی با فیلتر فعلی یافت نشد.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </article>
  </section>

  <footer class="admin-page__footer">
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-right"></i>
      بازگشت به داشبورد
    </a>
  </footer>
</div>
{% endblock %}
