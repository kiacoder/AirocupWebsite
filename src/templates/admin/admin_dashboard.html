{% extends "global/base.html" %}
{% block title %}داشبورد مدیریت | پنل آیروکاپ{% endblock %}

{% block body %}
<div class="admin-dashboard">
  <section class="admin-dashboard__hero">
    <div class="admin-dashboard__welcome">
      <h1>
        سلام
        {{ admin_greeting_name | default('مدیر محترم', true) | persian_digits }}!
      </h1>
      <p>
        آخرین وضعیت سامانه در یک نگاه؛ پیگیری تیم‌ها، پرداخت‌ها و پیام‌های کاربران را از همین‌جا انجام دهید.
      </p>
    </div>

    <div class="admin-dashboard__highlights">
      <div class="admin-dashboard__highlight">
        <span class="admin-dashboard__highlight-label">در انتظار بررسی</span>
        <strong>{{ pending_payments_count | persian_digits }}</strong>
        <small>رسید پرداخت</small>
      </div>
      <div class="admin-dashboard__highlight">
        <span class="admin-dashboard__highlight-label">عضویت‌های جدید</span>
        <strong>{{ stats.new_clients_this_week | default(0, true) | persian_digits }}</strong>
        <small>در هفته جاری</small>
      </div>
    </div>
  </section>

  <section class="admin-dashboard__actions">
    <h2>میانبرهای مدیریتی</h2>
    <div class="admin-dashboard__actions-grid">
      <a href="{{ url_for('admin.admin_clients_list') }}" class="admin-action-card">
        <i class="fas fa-users"></i>
        <span>مدیریت کاربران</span>
        <small>ویرایش اطلاعات و دسترسی‌ها</small>
      </a>
      <a href="{{ url_for('admin.admin_manage_teams') }}" class="admin-action-card">
        <i class="fas fa-layer-group"></i>
        <span>مدیریت تیم‌ها</span>
        <small>بررسی مدارک و وضعیت تیم‌ها</small>
      </a>
      <a href="{{ url_for('admin.admin_manage_news') }}" class="admin-action-card">
        <i class="fas fa-newspaper"></i>
        <span>مدیریت اخبار</span>
        <small>انتشار اطلاعیه‌های جدید</small>
      </a>
      <a href="{{ url_for('admin.admin_select_chat') }}" class="admin-action-card">
        <i class="fas fa-envelope"></i>
        <span>پیام‌ها</span>
        <small>پاسخ به سوالات شرکت‌کنندگان</small>
      </a>
    </div>
  </section>

  <section class="admin-dashboard__stats">
    <div class="admin-metric-card">
      <div class="admin-metric-card__icon"><i class="fas fa-users"></i></div>
      <div>
        <h3>{{ stats.total_members | default(0) | persian_digits }}</h3>
        <p>کل شرکت کنندگان</p>
      </div>
    </div>
    <div class="admin-metric-card">
      <div class="admin-metric-card__icon"><i class="fas fa-layer-group"></i></div>
      <div>
        <h3>{{ stats.total_teams | default(0) | persian_digits }}</h3>
        <p>تعداد کل تیم‌ها</p>
      </div>
    </div>
    <div class="admin-metric-card">
      <div class="admin-metric-card__icon"><i class="fas fa-check-circle"></i></div>
      <div>
        <h3>{{ stats.approved_teams | default(0) | persian_digits }}</h3>
        <p>تیم‌های تایید شده</p>
      </div>
    </div>
    <div class="admin-metric-card">
      <div class="admin-metric-card__icon"><i class="fas fa-user-friends"></i></div>
      <div>
        <h3>{{ stats.total_clients | default(0) | persian_digits }}</h3>
        <p>کاربران ثبت شده</p>
      </div>
    </div>
    <div class="admin-metric-card">
      <div class="admin-metric-card__icon"><i class="fas fa-user-tie"></i></div>
      <div>
        <h3>{{ stats.total_leaders | default(0) | persian_digits }}</h3>
        <p>تعداد سرپرست‌ها</p>
      </div>
    </div>
    <div class="admin-metric-card">
      <div class="admin-metric-card__icon"><i class="fas fa-chalkboard-teacher"></i></div>
      <div>
        <h3>{{ stats.total_coaches | default(0) | persian_digits }}</h3>
        <p>تعداد مربی‌ها</p>
      </div>
    </div>
  </section>

  <section class="admin-dashboard__charts">
    <article class="admin-chart-card">
      <header>
        <i class="fas fa-chart-pie"></i>
        <h3>پراکندگی استانی شرکت کنندگان</h3>
      </header>
      <div class="admin-chart-card__body">
        <canvas
          id="provinceChart"
          data-endpoint="{{ url_for('api_province_distribution') }}"
        ></canvas>
      </div>
    </article>
    <article class="admin-chart-card">
      <header>
        <i class="fas fa-chart-bar"></i>
        <h3>۱۰ شهر برتر شرکت کننده</h3>
      </header>
      <div class="admin-chart-card__body">
        <canvas
          id="cityChart"
          data-endpoint="{{ url_for('api_city_distribution') }}"
        ></canvas>
      </div>
    </article>
  </section>

  <section class="admin-dashboard__table">
    <header class="admin-dashboard__table-header">
      <div>
        <h2><i class="fas fa-credit-card"></i> رسیدهای پرداخت در انتظار تایید</h2>
        <p>در صورت تایید، وضعیت تیم‌ها به‌روزرسانی خواهد شد.</p>
      </div>
      <span class="admin-dashboard__badge">{{ pending_payments_count | persian_digits }} مورد</span>
    </header>

    <div class="admin-table-wrapper">
      <table class="admin-table">
        <thead>
          <tr>
            <th>تیم</th>
            <th>کاربر</th>
            <th>مبلغ (ریال)</th>
            <th>برای</th>
            <th>تاریخ</th>
            <th>رسید</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for payment, team_name, client_email in pending_payments %}
          <tr>
            <td data-label="تیم">{{ team_name }}</td>
            <td data-label="کاربر">{{ client_email }}</td>
            <td data-label="مبلغ">{{ payment.amount | humanize_number | persian_digits }}</td>
            <td data-label="برای">{{ payment.members_paid_for | persian_digits }} نفر</td>
            <td data-label="تاریخ">{{ payment.upload_date | formatdate | persian_digits }}</td>
            <td data-label="رسید">
              <a
                href="{{ url_for('client.get_receipt', client_id=payment.client_id, filename=payment.receipt_filename) }}"
                target="_blank"
                class="admin-table__link"
              >
                <i class="fas fa-receipt"></i>
                مشاهده
              </a>
            </td>
            <td class="admin-table__actions">
              <form
                action="{{ url_for('admin.admin_manage_payment', payment_id=payment.payment_id, action='approve') }}"
                method="POST"
                class="ConfirmAction"
                data-confirm="آیا از تایید این پرداخت اطمینان دارید؟"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-success btn-small">
                  <i class="fas fa-check"></i>
                  تایید
                </button>
              </form>
              <form
                action="{{ url_for('admin.admin_manage_payment', payment_id=payment.payment_id, action='reject') }}"
                method="POST"
                class="ConfirmAction"
                data-confirm="آیا از رد کردن این پرداخت اطمینان دارید؟"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-danger btn-small">
                  <i class="fas fa-times"></i>
                  رد
                </button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr class="admin-table__empty">
            <td colspan="7">
              <i class="fas fa-check-circle"></i>
              در حال حاضر هیچ پرداخت در انتظاری برای بررسی وجود ندارد.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
{% endblock %}
