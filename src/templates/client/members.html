{% extends "Global/Base.html" %}

{% block Title %}مدیریت اعضای تیم: {{ Team.TeamName }} | آیروکاپ{% endblock %}

{% block Body %}
<div class="AppContainer MembersPage" data-team-id="{{ Team.TeamID }}">
  <div class="Container">
    <div class="PageHeader">
      <h1 class="SectionTitle">تیم شما: {{ Team.TeamName }}</h1>
      <p class="SectionSubtitle">
        در این بخش اعضای تیم خود را اضافه، ویرایش یا حذف کنید.
      </p>
    </div>

    {% if is_paid and Team.UnpaidMembersCount > 0 %}
    <div class="Alert Alert--Warning" role="alert">
      <i class="fas fa-exclamation-triangle"></i>
      <p>
        <strong>توجه:</strong> شما {{ Team.UnpaidMembersCount | persian_digits }} عضو جدید اضافه کرده‌اید که هزینه آن‌ها پرداخت نشده است. لطفاً برای نهایی کردن ثبت‌نام آن‌ها به
        <a href="{{ url_for('Client.Payment', TeamID=Team.TeamID) }}">صفحه پرداخت</a>
        مراجعه کنید.
      </p>
    </div>
    {% endif %}

    <div class="Card Card--table">
      <h2 class="Card__header">
        اعضای فعلی ({{ Members|length | persian_digits }} از {{ AppConfig.MaxMembersPerTeam | persian_digits }})
      </h2>
      <div class="UserTableWrapper">
        <table class="UserTable">
          <thead>
            <tr>
              <th>نام و نام خانوادگی</th>
              <th>نقش</th>
              <th>کد ملی</th>
              <th class="ActionsHeader">عملیات</th>
            </tr>
          </thead>
          <tbody>
            {% for Member in Members %}
            <tr>
              <td data-label="نام">{{ Member.Name }}</td>
              <td data-label="نقش">{{ Member.Role.label }}</td>
              <td data-label="کد ملی" dir="ltr">
                {{ Member.NationalID | persian_digits or '-' }}
              </td>
              <td class="Actions">
                <a href="{{ url_for('Client.EditMember', TeamID=Team.TeamID, MemberID=Member.MemberID) }}" class="Btn BtnSecondary">
                  <i class="fas fa-edit"></i> ویرایش
                </a>
                <form action="{{ url_for('Client.DeleteMember', TeamID=Team.TeamID, MemberID=Member.MemberID) }}" method="POST" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button type="button" class="Btn BtnDanger DeleteBtn" data-modal-title="تایید حذف عضو" data-modal-text="آیا از حذف «{{ Member.Name }}» اطمینان دارید؟" data-modal-confirm="بله، حذف کن" {% if is_paid %}disabled title="پس از تایید پرداخت، امکان حذف عضو وجود ندارد."{% endif %}>
                    <i class="fas fa-trash"></i> حذف
                  </button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr class="EmptyStateRow">
              <td colspan="4" class="EmptyState">
                <i class="fas fa-users-slash EmptyState__icon"></i>
                این تیم هنوز عضوی ندارد.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if Members|length < AppConfig.MaxMembersPerTeam %}
    <div class="FormContainer" id="AddMemberFormContainer">
      <h2 class="FormTitle">افزودن عضو جدید</h2>
      <form method="POST" action="{{ url_for('Client.AddMember', TeamID=Team.TeamID) }}" id="AddMemberForm" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        {% with IdPrefix='Add-', MemberData=None, FormData=None %}
          {% include 'Client/MemberFormFields.html' %}
        {% endwith %}
        <div class="FormGroup">
          <button type="submit" class="Btn BtnPrimary Btn--fullWidth">
            افزودن عضو
          </button>
        </div>
      </form>
    </div>
    {% endif %}

    <div class="SectionCta" style="text-align: center; margin-bottom: 30px">
      <a href="{{ url_for('Client.Dashboard') }}" class="Btn BtnSecondary"><i class="fas fa-arrow-left"></i> بازگشت به داشبورد</a>
    </div>
  </div>
</div>
{% endblock %}

{% block Scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const addMemberForm = document.getElementById("AddMemberForm");
    if (addMemberForm) {
        FormHelpers.PopulateProvinces(addMemberForm.querySelector('[name="Province"]'));
        FormHelpers.SetupDatePicker(addMemberForm);
        FormHelpers.SetupProvinceCityListener(addMemberForm);
    }
    
    document.querySelectorAll('.DeleteBtn').forEach(button => {
        if (button.disabled) return;
        button.addEventListener('click', function() {
            const form = this.closest('form');
            FormHelpers.showConfirmModal(
                this.dataset.modalTitle,
                this.dataset.modalText,
                this.dataset.modalConfirm,
                () => form.submit()
            );
        });
    });
});
</script>
{% endblock %}