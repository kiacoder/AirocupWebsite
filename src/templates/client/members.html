{% extends "global/base.html" %}

{% block title %}مدیریت اعضای تیم: {{ team.team_name }}{% endblock %}

{% block body %}
<main
  class="app-container members-page"
  data-team-id="{{ team.team_id }}"
>
  <div class="container">
    <header class="page-header">
      <h1 class="page-title">تیم شما: {{ team.team_name }}</h1>
      <p class="page-subtitle">
        در این بخش اعضای تیم خود را اضافه، ویرایش یا حذف کنید.
      </p>
    </header>

    {% if is_paid and team.unpaid_members_count > 0 %}
    <div class="alert alert--warning" role="alert">
      <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
      <p>
        <strong>توجه:</strong>
        شما {{ team.unpaid_members_count | persian_digits }} عضو جدید اضافه کرده‌اید که هزینه آن‌ها پرداخت نشده است.
        لطفاً برای نهایی کردن ثبت‌نام آن‌ها به
        <a href="{{ url_for('client.payment', team_id=team.team_id) }}">صفحه پرداخت</a>
        مراجعه کنید.
      </p>
    </div>
    {% endif %}

    <section class="card card--table">
      <header class="card-header">
        <h2>
          اعضای فعلی ({{ members|length | persian_digits }} از {{ app_config.max_members_per_team | persian_digits }})
        </h2>
      </header>
      <div class="user-table-wrapper">
        <table class="user-table">
          <thead>
            <tr>
              <th>نام و نام خانوادگی</th>
              <th>نقش</th>
              <th>کد ملی</th>
              <th class="actions">عملیات</th>
            </tr>
          </thead>
          <tbody>
            {% for member in members %}
            <tr>
              <td data-label="نام">{{ member.name }}</td>
              <td data-label="نقش">{{ member.role.label }}</td>
              <td data-label="کد ملی" dir="ltr">
                {{ member.national_id | persian_digits or '-' }}
              </td>
              <td class="actions">
                <a
                  href="{{ url_for('client.edit_member', team_id=team.team_id, member_id=member.member_id) }}"
                  class="btn btn-secondary btn-sm"
                >
                  <i class="fas fa-edit" aria-hidden="true"></i>
                  ویرایش
                </a>
                <form
                  action="{{ url_for('client.delete_member', team_id=team.team_id, member_id=member.member_id) }}"
                  method="POST"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  {% set is_archive_locked = is_paid %}
                  <button
                    type="button"
                    class="btn btn-danger btn-sm delete-btn"
                    data-modal-title="تایید حذف عضو"
                    data-modal-body="آیا از حذف «{{ member.name }}» اطمینان دارید؟"
                    data-modal-confirm-text="بله، حذف کن"
                    {% if is_archive_locked %}
                    disabled
                    title="پس از تایید پرداخت، امکان حذف عضو وجود ندارد."
                    {% endif %}
                  >
                    <i class="fas fa-trash" aria-hidden="true"></i>
                    حذف
                  </button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr class="empty-state-row">
              <td colspan="4" class="empty-state">
                <i class="fas fa-users-slash empty-state-icon" aria-hidden="true"></i>
                این تیم هنوز عضوی ندارد.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    {% if members|length < app_config.max_members_per_team %}
    <section class="form-container form-container--medium" id="addMemberFormContainer">
      <h2 class="form-title">افزودن عضو جدید</h2>
      <form
        method="POST"
        action="{{ url_for('client.add_member', team_id=team.team_id) }}"
        id="addMemberForm"
        novalidate
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        {% with id_prefix='add-', member_data=None, form_data=None %}
          {% include 'client/member_form_fields.html' %}
        {% endwith %}
        <div class="form-group">
          <button type="submit" class="btn btn-primary btn--full-width">
            افزودن عضو
          </button>
        </div>
      </form>
    </section>
    {% endif %}

    <div class="section-cta">
      <a href="{{ url_for('client.dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left" aria-hidden="true"></i>
        بازگشت به داشبورد
      </a>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
  {{ super() }}
{% endblock %}
