{# This is a partial template included in create_team.html, members.html, etc. #}
{% set has_form_data = form_data is defined and form_data and form_data|length > 0 %}
{% set member_city = member_data.city if member_data and member_data.city is defined else None %}
{% set member_birth_date = member_data.birth_date if member_data and member_data.birth_date is defined else None %}

{% set name_value = form_data.get('name') if has_form_data else (member_data.name if member_data and member_data.name is defined else '') %}
{% set national_id_value = form_data.get('national_id') if has_form_data else (member_data.national_id if member_data and member_data.national_id is defined else '') %}
{% set role_value = form_data.get('role') if has_form_data else (member_data.role.value if member_data and member_data.role is defined else '') %}
{% set province_value = form_data.get('province') if has_form_data else (member_city.province.name if member_city and member_city.province is defined else '') %}
{% set city_value = form_data.get('city') if has_form_data else (member_city.name if member_city and member_city.name is defined else '') %}

{% if has_form_data %}
  {% set birth_year_value = form_data.get('birth_year') %}
  {% set birth_month_value = form_data.get('birth_month') %}
  {% set birth_day_value = form_data.get('birth_day') %}
{% elif member_birth_date %}
  {% set birth_parts = member_birth_date | formatdate | split('-') %}
  {% set birth_year_value = birth_parts[0] %}
  {% set birth_month_value = birth_parts[1] %}
  {% set birth_day_value = birth_parts[2] %}
{% else %}
  {% set birth_year_value = '' %}
  {% set birth_month_value = '' %}
  {% set birth_day_value = '' %}
{% endif %}

<div class="form-grid">
  <div class="form-group">
    <label for="{{ id_prefix }}name">نام و نام خانوادگی:<span class="required-star">*</span></label>
    <input
      id="{{ id_prefix }}name"
      name="name"
      type="text"
      class="form-control"
      required
      value="{{ name_value }}"
    />
  </div>
  <div class="form-group">
    <label for="{{ id_prefix }}national_id">کد ملی:<span class="required-star">*</span></label>
    <input
      id="{{ id_prefix }}national_id"
      name="national_id"
      type="text"
      class="form-control"
      inputmode="numeric"
      maxlength="10"
      required
      value="{{ national_id_value }}"
      dir="ltr"
    />
  </div>
</div>

<div class="form-grid">
  <div class="form-group">
    <label for="{{ id_prefix }}role">نقش در تیم:<span class="required-star">*</span></label>
    <select id="{{ id_prefix }}role" name="role" class="form-control" required>
      <option value="">انتخاب کنید...</option>
      <option value="member" {% if role_value == 'member' %}selected{% endif %}>عضو</option>
      <option value="coach" {% if role_value == 'coach' %}selected{% endif %}>مربی</option>
      <option value="leader" {% if role_value == 'leader' %}selected{% endif %}>سرپرست</option>
    </select>
  </div>
</div>

<div class="form-grid">
  <div class="form-group">
    <label for="{{ id_prefix }}province">استان:<span class="required-star">*</span></label>
    <select
      id="{{ id_prefix }}province"
      name="province"
      class="form-control"
      required
      data-initial-value="{{ province_value }}"
    >
      <option value="">استان را انتخاب کنید</option>
      {% for province_name in Provinces.keys() | list | sort %}
        <option
          value="{{ province_name }}"
          {% if province_name == province_value %}selected{% endif %}
        >
          {{ province_name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="form-group">
    <label for="{{ id_prefix }}city">شهر:<span class="required-star">*</span></label>
    <select
      id="{{ id_prefix }}city"
      name="city"
      class="form-control"
      required
      data-initial-value="{{ city_value }}"
    >
      {% set city_options = Provinces.get(province_value, []) if province_value else [] %}
      <option value="">{{ 'ابتدا استان را انتخاب کنید' if not city_options else 'شهر را انتخاب کنید' }}</option>
      {% if city_options %}
        {% for city_name in city_options | sort %}
          <option
            value="{{ city_name }}"
            {% if city_name == city_value %}selected{% endif %}
          >
            {{ city_name }}
          </option>
        {% endfor %}
      {% else %}
        {% for province_name, cities in Provinces | dictsort %}
          <optgroup label="{{ province_name }}">
            {% for city_name in cities | sort %}
              <option value="{{ city_name }}">{{ city_name }}</option>
            {% endfor %}
          </optgroup>
        {% endfor %}
      {% endif %}
    </select>
  </div>
</div>

<div class="form-group">
  <label>تاریخ تولد<span class="required-star">*</span></label>
  <div class="datepicker-group">
    {% set birth_day_int = birth_day_value | int if birth_day_value else None %}
    {% set birth_month_int = birth_month_value | int if birth_month_value else None %}
    {% set birth_year_int = birth_year_value | int if birth_year_value else None %}
    <select
      id="{{ id_prefix }}birth_day"
      name="birth_day"
      class="form-control"
      required
      data-initial-value="{{ birth_day_value }}"
    >
      <option value="">روز</option>
      {% for day in range(1, 32) %}
        <option value="{{ day }}" {% if birth_day_int and birth_day_int == day %}selected{% endif %}>
          {{ day | persian_digits }}
        </option>
      {% endfor %}
    </select>
    <select
      id="{{ id_prefix }}birth_month"
      name="birth_month"
      class="form-control"
      required
      data-initial-value="{{ birth_month_value }}"
    >
      <option value="">ماه</option>
      {% for month_number, month_name in PersianMonths | dictsort %}
        <option
          value="{{ month_number }}"
          {% if birth_month_int and birth_month_int == month_number %}selected{% endif %}
        >
          {{ month_name }}
        </option>
      {% endfor %}
    </select>
    <select
      id="{{ id_prefix }}birth_year"
      name="birth_year"
      class="form-control"
      required
      data-initial-value="{{ birth_year_value }}"
    >
      <option value="">سال</option>
      {% for year in AllowedYears | sort(reverse=True) %}
        <option value="{{ year }}" {% if birth_year_int and birth_year_int == year %}selected{% endif %}>
          {{ year | persian_digits }}
        </option>
      {% endfor %}
    </select>
  </div>
</div>
