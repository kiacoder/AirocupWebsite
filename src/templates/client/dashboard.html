{% extends "global/base.html" %}

{% block title %}داشبورد | آیروکاپ{% endblock %}

{% block body %}
<div class="dashboard-container container" style="margin: 2rem auto">
  <div class="section-header" style="margin-bottom: 2rem">
    <h1 class="section-title">به داشبورد خود خوش آمدید</h1>
    <p class="form-subtitle" style="margin-bottom: 0">
      این پنل شخصی شما برای مدیریت تمام تیم‌هایتان است.
    </p>
  </div>

  <div class="form-grid" style="gap: 1.5rem; margin-bottom: 2rem">
    <div
      class="card"
      style="
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        border: none;
        background: var(--color-background-muted);
      "
    >
      <span
        class="form-subtitle"
        style="
          margin-bottom: 0;
          color: var(--color-text);
          display: flex;
          align-items: center;
          gap: 0.5rem;
        "
      >
        <i class="fas fa-layer-group" style="color: var(--color-primary)"></i>
        تعداد تیم‌های من
      </span>
      <strong style="font-size: 1.4rem">
        {{ teams|length | persian_digits }} تیم
      </strong>
    </div>
    <div
      class="card"
      style="
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        border: none;
        background: var(--color-background-muted);
      "
    >
      <span
        class="form-subtitle"
        style="
          margin-bottom: 0;
          color: var(--color-text);
          display: flex;
          align-items: center;
          gap: 0.5rem;
        "
      >
        <i class="fas fa-users-cog" style="color: var(--color-secondary)"></i>
        سقف مجاز تیم‌ها
      </span>
      <strong style="font-size: 1.4rem">
        {{ app_config.max_team_per_client | persian_digits }} تیم
      </strong>
    </div>
  </div>

  <div
    class="card"
    style="margin-bottom: 2rem; border-left: 5px solid var(--color-primary)"
  >
    <h3
      style="
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.3rem;
      "
    >
      <i class="fas fa-file-invoice-dollar" style="color: var(--color-primary)"></i>
      اطلاعات و هزینه‌های ثبت‌نام
    </h3>
    <div class="form-grid" style="gap: 1.5rem">
      <div
        class="detail-item"
        style="
          border: none;
          padding: 1rem;
          background: var(--color-background-muted);
          border-radius: var(--border-radius-small);
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        "
      >
        <span style="display: flex; align-items: center; gap: 0.5rem">
          <i class="fas fa-users" style="color: var(--color-primary-dark)"></i>
          هزینه ورودی تیم
        </span>
        <strong>
          {{ (payment.fee_team or 0) | humanize_number | persian_digits }} ریال
        </strong>
      </div>
      <div
        class="detail-item"
        style="
          border: none;
          padding: 1rem;
          background: var(--color-background-muted);
          border-radius: var(--border-radius-small);
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        "
      >
        <span style="display: flex; align-items: center; gap: 0.5rem">
          <i class="fas fa-user-plus" style="color: var(--color-primary-dark)"></i>
          هزینه هر عضو
        </span>
        <strong>
          {{ (payment.fee_per_person or 0) | humanize_number | persian_digits }}
          ریال
        </strong>
      </div>
      <div
        class="detail-item grid-col-span-2"
        style="
          border: none;
          padding: 1rem;
          background: var(--color-background-muted);
          border-radius: var(--border-radius-small);
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        "
      >
        <span style="display: flex; align-items: center; gap: 0.5rem">
          <i class="fas fa-percent" style="color: var(--color-secondary-dark)"></i>
          تخفیف ثبت‌نام در لیگ دوم
        </span>
        <strong>
          {{ (payment.league_two_discount or 0) | persian_digits }} درصد
        </strong>
      </div>
    </div>
    <div
      style="
        padding-top: 1.5rem;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      "
    >
      <p style="margin-bottom: 0">
        <strong>نکته:</strong> هزینه ورودی تیم، یک هزینه ثابت برای هر تیم است و
        به هزینه اعضا اضافه می‌گردد.
      </p>
      <a
        href="{{ url_for('client.my_history') }}"
        class="btn btn-secondary btn-sm"
      >
        <i class="fas fa-history"></i> مشاهده سوابق پرداخت
      </a>
    </div>
  </div>

  {% if teams|length < app_config.max_team_per_client %}
  <div class="dashboard-actions">
    <a
      href="{{ url_for('client.create_team') }}"
      class="btn btn-primary btn--full-width"
      style="max-width: 280px"
    >
      <i class="fas fa-plus"></i> ایجاد تیم جدید
    </a>
  </div>
  {% endif %}

  <div class="team-card-grid">
    {% set status_class_map = {
      'approved': 'status-approved',
      'pending': 'status-pending',
      'rejected': 'status-rejected'
    } %}
    {% set status_label_map = {
      'approved': 'تایید شده',
      'pending': 'در حال بررسی',
      'rejected': 'رد شده'
    } %}
    {% for team in teams %}
    <div class="card card-team">
      <div class="team-card-header">
        <div class="team-card-title">
          <span class="team-card-icon" aria-hidden="true">
            <i class="fas fa-users"></i>
          </span>
          <h3 class="team-card-name">{{ team.team_name }}</h3>
        </div>
        {% set status_enum = team.last_payment_status %}
        {% set status_value =
          status_enum.value if status_enum and status_enum is not string else status_enum
        %}
        {% set status_label =
          status_enum.label
          if status_enum and status_enum is not string
          else status_label_map.get(status_value, 'شروع نشده')
        %}
        {% set status_class = status_class_map.get(status_value, 'status-not-started') %}
        <span class="status-badge {{ status_class }}">{{ status_label }}</span>
      </div>

      <div class="team-card-body">
        <div class="team-card-meta-item">
          <span class="team-card-meta-label"
            ><i class="fas fa-user-friends"></i> تعداد اعضا</span
          >
          <strong class="team-card-meta-value"
            >{{ team.members|length | persian_digits }} نفر</strong
          >
        </div>
        <div class="team-card-meta-item">
          <span class="team-card-meta-label"
            ><i class="fas fa-trophy"></i> لیگ‌ها</span
          >
          <strong class="team-card-meta-value">
            {{ team.league_one.name if team.league_one else 'انتخاب نشده' }}{% if
            team.league_two %}<br />و {{ team.league_two.name }}{% endif %}
          </strong>
        </div>
        {% if team.average_age and team.average_age > 0 %}
        <div class="team-card-meta-item">
          <span class="team-card-meta-label"
            ><i class="fas fa-birthday-cake"></i> میانگین سنی</span
          >
          <strong class="team-card-meta-value"
            >~{{ team.average_age | persian_digits }} سال</strong
          >
        </div>
        {% endif %}
        {% if team.average_provinces %}
        <div class="team-card-meta-item">
          <span class="team-card-meta-label"
            ><i class="fas fa-map-marker-alt"></i> استان‌ها</span
          >
          <strong class="team-card-meta-value team-card-meta-value--muted"
            >{{ team.average_provinces }}</strong
          >
        </div>
        {% endif %}
      </div>

      <div class="team-card-footer">
        <a
          href="{{ url_for('client.manage_members', team_id=team.team_id) }}"
          class="btn btn-primary"
        >
          <i class="fas fa-users"></i> مدیریت اعضا
        </a>
        <a
          href="{{ url_for('client.update_team', team_id=team.team_id) }}"
          class="btn btn-secondary"
        >
          <i class="fas fa-edit"></i> ویرایش تیم
        </a>

        {% set is_league_selection_disabled = team.last_payment_status and
        team.last_payment_status.value == 'approved' %}
        <a
          href="{{ url_for('client.select_league', team_id=team.team_id) if not is_league_selection_disabled else '#' }}"
          class="btn btn-secondary {% if is_league_selection_disabled %}btn-disabled{% endif %}"
          {% if is_league_selection_disabled %}
            aria-disabled="true"
            title="امکان تغییر لیگ پس از تایید پرداخت وجود ندارد."
          {% endif %}
        >
          <i class="fas fa-trophy"></i> انتخاب لیگ
        </a>

        {% set is_ready_for_payment = team.members|length > 0 and team.league_one_id %}
        <a
          href="{{ url_for('client.payment', team_id=team.team_id) if is_ready_for_payment else '#' }}"
          class="btn btn-success {% if not is_ready_for_payment %}btn-disabled{% endif %}"
          {% if not is_ready_for_payment %}
            aria-disabled="true"
            title="برای پرداخت، تیم باید حداقل یک عضو و یک لیگ انتخاب شده داشته باشد."
          {% endif %}
        >
          <i class="fas fa-credit-card"></i> پرداخت
        </a>

        <form
          action="{{ url_for('client.delete_team', team_id=team.team_id) }}"
          method="POST"
          class="team-card-archive-form"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          {% set is_archive_disabled = team.last_payment_status and
          team.last_payment_status.value in ['approved', 'pending'] %}
          <button
            type="button"
            class="btn btn-danger delete-btn"
            data-modal-title="تایید آرشیو تیم"
            data-modal-body="آیا از آرشیو کردن تیم «{{ team.team_name }}» اطمینان دارید؟"
            data-modal-confirm-text="بله، آرشیو کن"
            {% if is_archive_disabled %}
              disabled
              title="پس از تایید یا در زمان بررسی پرداخت، امکان آرشیو تیم وجود ندارد."
            {% endif %}
          >
            <i class="fas fa-archive"></i> آرشیو
          </button>
        </form>
      </div>
    </div>
    {% else %}
    <div class="card empty-state-card">
      <i class="fas fa-users-slash empty-state-icon"></i>
      <h3>هنوز هیچ تیمی نساخته‌اید</h3>
      <p>
        برای شروع ماجراجویی خود، روی دکمه "ایجاد تیم جدید" در بالا کلیک کنید!
      </p>
    </div>
    {% endfor %}
  </div>

  <div style="margin-top: 2rem">
    <a href="{{ url_for('global.logout') }}" class="btn btn-secondary">
      <i class="fas fa-sign-out-alt"></i> خروج از حساب کاربری
    </a>
  </div>
</div>

{# This is the global confirmation modal that main.js will use #}
<div
  class="modal"
  id="confirmationModal"
  role="alertdialog"
  aria-modal="true"
  aria-labelledby="modalTitle"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <button class="close-btn" data-dismiss="modal" aria-label="بستن">
        &times;
      </button>
      <h3 id="modalTitle" class="modal-title"></h3>
      <p class="modal-body"></p>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          انصراف
        </button>
        <button type="button" id="confirmModalBtn" class="btn btn-danger"></button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
{% endblock %}
