{% extends "Global/Base.html" %}

{% block Title %}تایید شماره موبایل | آیروکاپ{% endblock %}

{% block Body %}
<main class="AppContainer">
  <div class="FormContainer FormContainer--small">
    <form
      method="POST"
      action="{{ url_for('client.verify_code') }}"
      id="verificationForm"
      data-cooldown="{{ Cooldown or 0 }}"
      data-client-id="{{ ClientID or '' }}"
      data-action="phone_signup"
      data-resend-url="{{ url_for('client.resend_code') }}"
      data-csrf-token="{{ csrf_token() }}"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="Action" value="phone_signup" />
      <input type="hidden" name="ClientID" value="{{ ClientID or '' }}" />

      <h1 class="FormTitle">تایید شماره موبایل</h1>
      <p class="FormSubtitle">
        یک کد ۶ رقمی به شماره موبایل شما ارسال شد. لطفا آن را در کادر زیر وارد کنید.
      </p>

      <div class="FormGroup">
        <label for="code">کد تایید<span class="RequiredStar">*</span></label>
        <input
          type="text"
          id="code"
          name="Code"
          class="FormControl"
          placeholder="کد ۶ رقمی"
          required
          autofocus
          dir="ltr"
          maxlength="6"
          pattern="\d{6}"
          inputmode="numeric"
          autocomplete="one-time-code"
          title="لطفا یک کد ۶ رقمی وارد کنید."
        />
      </div>

      <div class="FormGroup">
        <button type="submit" class="Btn BtnPrimary Btn--fullWidth">
          تایید و فعال‌سازی حساب
        </button>
      </div>

      <div class="ResendContainer">
        <button type="button" id="resendButton" class="Btn Btn--link">
          ارسال مجدد کد
        </button>
        <span id="timerDisplay"></span>
      </div>
    </form>
  </div>
</main>
{% endblock %}

{% block Scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("verificationForm");
    const resendButton = document.getElementById("resendButton");
    const timerDisplay = document.getElementById("timerDisplay");

    if (!form || !resendButton || !timerDisplay) return;

    const clientID = form.dataset.clientId;
    const resendUrl = form.dataset.resendUrl;
    const csrfToken = form.dataset.csrfToken;
    const action = form.dataset.action;
    let countdown = parseInt(form.dataset.cooldown, 10) || 0;

    const resendCode = async function () {
      if (countdown > 0) return;

      try {
        const response = await fetch(resendUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({ ClientID: clientID, Action: action }),
        });

        const data = await response.json();

        if (response.ok) {
          CreateFlash('Success', data.Message);
          startTimer(180);
        } else {
          CreateFlash('Error', data.Message || 'خطایی در ارسال مجدد کد رخ داد.');
        }
      } catch (error) {
        console.error("Resend error:", error);
        CreateFlash('Error', 'خطا در ارتباط با سرور. لطفا اتصال اینترنت خود را بررسی کنید.');
      }
    };

    function startTimer(duration) {
      countdown = duration;
      resendButton.disabled = true;
      resendButton.style.opacity = "0.6";
      resendButton.style.cursor = "not-allowed";

      const interval = setInterval(() => {
        const minutes = Math.floor(countdown / 60);
        const seconds = countdown % 60;
        timerDisplay.textContent = `(${minutes}:${seconds.toString().padStart(2, '0')})`;

        if (--countdown < 0) {
          clearInterval(interval);
          timerDisplay.textContent = "";
          resendButton.disabled = false;
          resendButton.style.opacity = "1";
          resendButton.style.cursor = "pointer";
        }
      }, 1000);
    }

    resendButton.addEventListener('click', resendCode);

    if (countdown > 0) {
      startTimer(countdown);
    }
  });
</script>
{% endblock %}