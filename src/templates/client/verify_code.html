{% extends "global/base.html" %} {% block title %}تایید کد | آیروکاپ{% endblock
%} {% block body %}
<div class="app-container">
  <div class="form-container form-container--small">
    <form method="POST" action="{{ url_for('client.verify_code') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="action" value="{{ action }}" />
      <input type="hidden" name="client_id" value="{{ client_id or '' }}" />
      <input type="hidden" name="identifier" value="{{ identifier or '' }}" />
      <input
        type="hidden"
        name="identifier_type"
        value="{{ identifier_type or '' }}"
      />

      <h1 class="form-title">تایید کد</h1>

      <p class="form-subtitle">
        {% if action == 'phone_signup' %} یک کد ۶ رقمی به شماره موبایل شما ارسال
        شد. لطفا آن را وارد کنید. {% elif action == 'password_reset' %} یک کد ۶
        رقمی به {{ 'ایمیل' if identifier_type == 'Email' else 'شماره موبایل' }}
        شما ارسال شد. لطفا آن را وارد کنید. {% endif %}
      </p>

      <div class="form-group">
        <label for="code">کد تایید:</label>
        <input
          type="text"
          id="code"
          name="code"
          placeholder="کد ۶ رقمی"
          required
          autofocus
          dir="ltr"
          maxlength="6"
          pattern="\d{6}"
          inputmode="numeric"
          title="لطفا یک کد ۶ رقمی وارد کنید."
        />
      </div>

      <div class="form-group">
        <button type="submit" class="btn btn-primary btn--full-width">
          تایید کد
        </button>
      </div>

      <div class="form-links" style="margin-top: 1rem; text-align: center">
        <button type="button" id="resendButton" class="link-button">
          ارسال مجدد کد
        </button>
        <span id="timerDisplay" style="margin-right: 10px; color: #666"></span>
      </div>

      <div class="password-requirements" style="margin-top: 2rem; text-align: right;">
        <p style="margin-bottom: 0.5rem; color: var(--color-danger);">کد را دریافت نکردید؟</p>
        <ul style="list-style: disc; padding-right: 1.5rem; margin: 0; color: var(--color-text-muted);">
          <li><strong>ایمیل:</strong> لطفاً پوشه <strong>Spam (هرزنامه)</strong>، <strong>Junk</strong> یا <strong>Promotions</strong> ایمیل خود را بررسی کنید.</li>
          <li><strong>پیامک:</strong> اگر کد را دریافت نمی‌کنید، ممکن است توسط گوشی یا اپلیکیشن‌ها مسدود شده باشد:
            <ul style="list-style: circle; padding-right: 1.5rem; margin-top: 0.5rem;">
              <li><strong>شیائومی (Xiaomi):</strong> برنامه پیام‌ها (Messages) &larr; تنظیمات &larr; بخش Spam & Blocked را چک کنید.</li>
              <li><strong>سامسونگ و گوگل:</strong> در برنامه پیام‌ها &larr; منوی سه نقطه &larr; Spam & Blocked.</li>
              <li><strong>آیفون (iOS):</strong> تنظیمات (Settings) &larr; Messages &larr; بخش Unknown & Spam.</li>
              <li>اگر از برنامه‌هایی مثل <strong>Truecaller</strong> استفاده می‌کنید، لیست پیام‌های مسدود شده آن را بررسی کنید.</li>
            </ul>
          </li>
        </ul>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {

    const resendButton = document.getElementById("resendButton");
    const timerDisplay = document.getElementById("timerDisplay");

    // MUST match the hidden inputs above
    const action = "{{ action }}";
    const clientID = "{{ client_id or '' }}";
    const identifier = "{{ identifier or '' }}";
    const identifierType = "{{ identifier_type or '' }}";
    let countdown = {{ cooldown or 0 }};

    const resendCode = async function () {
      if (countdown > 0) return;

      try {
        const response = await fetch("{{ url_for('client.verify_code') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}",
          },
          body: JSON.stringify({
            Action: action,
            client_id: client_id,
            Identifier: identifier,
            IdentifierType: identifierType,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          CreateFlash('Success', data.Message);
          startTimer(180);
        } else {
          CreateFlash('Error', data.Message || 'خطایی در ارسال مجدد کد رخ داد.');
        }

      } catch (error) {
        console.error("Resend error:", error);
        CreateFlash('Error', 'خطا در ارتباط با سرور. لطفا اتصال اینترنت خود را بررسی کنید.');
      }
    };

    function startTimer(duration) {
      countdown = duration;
      resendButton.disabled = true;
      resendButton.style.opacity = "0.6";
      resendButton.style.cursor = "not-allowed";

      const interval = setInterval(() => {
        const minutes = Math.floor(countdown / 60);
        const seconds = countdown % 60;

        timerDisplay.textContent = `(${minutes}:${seconds.toString().padStart(2, '0')})`;

        if (--countdown < 0) {
          clearInterval(interval);
          timerDisplay.textContent = "";
          resendButton.disabled = false;
          resendButton.style.opacity = "1";
          resendButton.style.cursor = "pointer";
        }

      }, 1000);
    }

    resendButton.addEventListener('click', resendCode);

    if (countdown > 0) startTimer(countdown);

  });
</script>
{% endblock %}
