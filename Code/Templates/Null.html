{% extends "Global/Base.html" %}
{% block Title %}تکمیل اطلاعات حساب کاربری | آیروکاپ{% endblock %}

{% block Head %}
<style>
    /* These styles highlight the fields that have errors */
    .FormGroup.has-error .FormControl,
    .FormGroup.has-error .DatepickerGroup {
        border-color: var(--ColorDanger);
        box-shadow: 0 0 0 2px var(--ColorDanger) !important;
    }
    .ErrorMsg {
        color: var(--ColorDanger);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block Body %}
<div class="AppContainer">
    <div class="FormContainer FormContainer--large">
        <form method="POST" action="{{ url_for('SubmitDataResolution') }}" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 class="FormTitle">تکمیل و اصلاح اطلاعات</h1>
                <p class="FormSubtitle">
                    حساب کاربری شما به دلیل وجود اطلاعات ناقص یا نامعتبر به طور موقت غیرفعال شده است.
                    <br>
                    لطفاً موارد مشخص شده با رنگ قرمز را اصلاح کرده و فرم را ارسال کنید تا حساب شما مجدداً فعال شود.
                </p>
            </div>

            {% for Team in Client.Teams %}
                {% for Member in Team.Members %}
                    {% set member_problems = Problems.get(Member.MemberID|string, {}) %}
                    {% set missing_fields = member_problems.get('Missing', []) %}
                    {% set invalid_fields = member_problems.get('Invalid', []) %}

                    <fieldset class="FormSection">
                        <legend class="FormSection__Title">عضو: {{ Member.Name or '[بدون نام]' }} | تیم: {{ Team.TeamName }}</legend>

                        <div class="FormGrid">
                            {% set field_name = 'Name' %}
                            <div class="FormGroup Grid-col-span-2 {% if field_name in missing_fields %}has-error{% endif %}">
                                <label for="member_name_{{ Member.MemberID }}">نام و نام خانوادگی<span class="RequiredStar">*</span></label>
                                <input type="text" id="member_name_{{ Member.MemberID }}" name="member_name_{{ Member.MemberID }}" value="{{ Member.Name or '' }}" class="FormControl" required>
                                {% if field_name in missing_fields %}<span class="ErrorMsg">نام و نام خانوادگی الزامی است.</span>{% endif %}
                            </div>

                            {% set field_name = 'NationalID' %}
                            <div class="FormGroup {% if field_name in missing_fields %}has-error{% endif %}">
                                <label for="member_nationalid_{{ Member.MemberID }}">کد ملی<span class="RequiredStar">*</span></label>
                                <input type="text" id="member_nationalid_{{ Member.MemberID }}" name="member_nationalid_{{ Member.MemberID }}" value="{{ Member.NationalID or '' }}" class="FormControl" required dir="ltr">
                                {% if field_name in missing_fields %}<span class="ErrorMsg">کد ملی الزامی است.</span>{% endif %}
                            </div>

                            {% set field_name = 'Role' %}
                            <div class="FormGroup {% if field_name in missing_fields %}has-error{% endif %}">
                                <label for="member_role_{{ Member.MemberID }}">نقش در تیم<span class="RequiredStar">*</span></label>
                                <select id="member_role_{{ Member.MemberID }}" name="member_role_{{ Member.MemberID }}" class="FormControl" required>
                                    {% for role in MemberRole %}
                                        <option value="{{ role.label }}" {% if Member.Role == role %}selected{% endif %}>{{ role.label }}</option>
                                    {% endfor %}
                                </select>
                                {% if field_name in missing_fields %}<span class="ErrorMsg">انتخاب نقش الزامی است.</span>{% endif %}
                            </div>
                            
                            {% set field_name = 'BirthDate' %}
                            <div class="FormGroup Grid-col-span-2 {% if field_name in missing_fields or invalid_fields %}has-error{% endif %}">
                                <label>تاریخ تولد<span class="RequiredStar">*</span></label>
                                {% set birth_parts = Member.BirthDate.split('-') if Member.BirthDate else ['','',''] %}
                                <div class="DatepickerGroup" data-birth-year="{{ birth_parts[0] }}" data-birth-month="{{ birth_parts[1] }}" data-birth-day="{{ birth_parts[2] }}">
                                    <select name="member_birthday_{{ Member.MemberID }}" class="FormControl" required><option value="">روز</option></select>
                                    <select name="member_birthmonth_{{ Member.MemberID }}" class="FormControl" required><option value="">ماه</option></select>
                                    <select name="member_birthyear_{{ Member.MemberID }}" class="FormControl" required><option value="">سال</option></select>
                                </div>
                                {% if field_name in missing_fields %}<span class="ErrorMsg">تاریخ تولد الزامی است.</span>{% endif %}
                                {% for error in invalid_fields %}
                                    {% if 'سن' in error or 'تاریخ' in error %}<span class="ErrorMsg">{{ error }}</span>{% endif %}
                                {% endfor %}
                            </div>

                            {% set field_name = 'Province' %}
                            <div class="FormGroup {% if field_name in missing_fields %}has-error{% endif %}">
                                <label for="member_province_{{ Member.MemberID }}">استان<span class="RequiredStar">*</span></label>
                                <select id="member_province_{{ Member.MemberID }}" name="member_province_{{ Member.MemberID }}" class="FormControl" required>
                                    <option value="">انتخاب کنید...</option>
                                    {% for province_name in Provinces.keys() %}
                                        <option value="{{ province_name }}" {% if Member.Province == province_name %}selected{% endif %}>{{ province_name }}</option>
                                    {% endfor %}
                                </select>
                                {% if field_name in missing_fields %}<span class="ErrorMsg">انتخاب استان الزامی است.</span>{% endif %}
                            </div>

                            {% set field_name = 'City' %}
                            <div class="FormGroup {% if field_name in missing_fields %}has-error{% endif %}">
                                <label for="member_city_{{ Member.MemberID }}">شهر<span class="RequiredStar">*</span></label>
                                <select id="member_city_{{ Member.MemberID }}" name="member_city_{{ Member.MemberID }}" class="FormControl" required data-initial-city="{{ Member.City or '' }}">
                                    <option value="">ابتدا استان را انتخاب کنید</option>
                                </select>
                                {% if field_name in missing_fields %}<span class="ErrorMsg">انتخاب شهر الزامی است.</span>{% endif %}
                            </div>
                        </div>
                    </fieldset>
                {% endfor %}
            {% endfor %}

            <div class="FormGroup" style="margin-top: 2rem;">
                <button type="submit" class="Btn BtnPrimary Btn--fullWidth">ذخیره و فعال‌سازی حساب</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block Scripts %}
<!-- FIX: This new script correctly initializes all forms on the page using your Main.js functions -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // AirocupData is loaded globally from Base.html now, so FormHelpers can initialize
    FormHelpers.initialize(); 

    document.querySelectorAll('form fieldset').forEach(fieldset => {
        // Initialize date picker and province/city listeners for each member's fieldset
        FormHelpers.setupDatePicker(fieldset);
        FormHelpers.setupProvinceCityListener(fieldset);
    });
});
</script>
{% endblock %}