{% extends "Global/Base.html" %}

{% block Title %}تنظیم رمز عبور جدید | آیروکاپ{% endblock %}

{% block Body %}
<div class="AppContainer">
  <div class="FormContainer FormContainer--small">
    <form method="POST" id="ResetForm" action="{{ url_for('client.reset_password', Token=Token) }}" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

      <h1 class="FormTitle">تنظیم رمز عبور جدید</h1>
      <p class="FormSubtitle">
        اکنون می‌توانید رمز عبور جدید خود را وارد کنید.
      </p>

      <div class="FormGroup">
        <label for="newPassword">رمز عبور جدید:</label>
        <div class="PasswordWrapper">
          <input type="password" id="newPassword" name="NewPassword" required autocomplete="new-password" autofocus dir="ltr" />
          <button type="button" class="PasswordToggle" data-target="#newPassword" aria-label="Show/Hide Password">
            <i class="fas fa-eye-slash"></i>
          </button>
        </div>
      </div>

      <div class="FormGroup">
        <label for="confirmPassword">تکرار رمز عبور جدید:</label>
        <div class="PasswordWrapper">
          <input type="password" id="confirmPassword" name="ConfirmPassword" required autocomplete="new-password" dir="ltr" />
          <button type="button" class="PasswordToggle" data-target="#confirmPassword" aria-label="Show/Hide Password">
            <i class="fas fa-eye-slash"></i>
          </button>
        </div>
        <span class="ErrorMsg" id="confirmPasswordError"></span>
      </div>

      <div class="PasswordRequirements">
        <p>رمز عبور باید شامل موارد زیر باشد:</p>
        <ul>
          <li id="req-length" class="invalid">حداقل ۸ کاراکتر</li>
          <li id="req-upper" class="invalid">حداقل یک حرف بزرگ انگلیسی</li>
          <li id="req-lower" class="invalid">حداقل یک حرف کوچک انگلیسی</li>
          <li id="req-number" class="invalid">حداقل یک عدد (۰-۹)</li>
          <li id="req-special" class="invalid">حداقل یک کاراکتر خاص (!@#$...)</li>
        </ul>
      </div>

      <div class="FormGroup">
        <button type="submit" id="submitBtn" class="Btn BtnPrimary Btn--fullWidth" disabled>
          ذخیره رمز عبور جدید
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block Scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("ResetForm");
    const newPasswordInput = document.getElementById("newPassword");
    const confirmPasswordInput = document.getElementById("confirmPassword");
    const confirmPasswordError = document.getElementById("confirmPasswordError");
    const submitBtn = document.getElementById("submitBtn");

    const requirements = {
        length: document.getElementById('req-length'),
        upper: document.getElementById('req-upper'),
        lower: document.getElementById('req-lower'),
        number: document.getElementById('req-number'),
        special: document.getElementById('req-special'),
    };

    function validatePassword() {
        const password = newPasswordInput.value;
        const checks = {
            length: password.length >= 8,
            upper: /[A-Z]/.test(password),
            lower: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
        };

        let allValid = true;
        for (const key in checks) {
            const el = requirements[key];
            if (checks[key]) {
                el.classList.remove('invalid');
                el.classList.add('valid');
            } else {
                el.classList.remove('valid');
                el.classList.add('invalid');
                allValid = false;
            }
        }
        return allValid;
    }

    function validateConfirmPassword() {
        const passwordsMatch = newPasswordInput.value === confirmPasswordInput.value;
        if (!passwordsMatch && confirmPasswordInput.value) {
            confirmPasswordError.textContent = "رمزهای عبور مطابقت ندارند.";
        } else {
            confirmPasswordError.textContent = "";
        }
        return passwordsMatch;
    }

    function updateSubmitButtonState() {
        const isPasswordValid = validatePassword();
        const arePasswordsMatching = validateConfirmPassword();
        submitBtn.disabled = !(isPasswordValid && arePasswordsMatching);
    }

    newPasswordInput.addEventListener('input', () => {
        validatePassword();
        updateSubmitButtonState();
    });

    confirmPasswordInput.addEventListener('input', updateSubmitButtonState);

    document.querySelectorAll('.PasswordToggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
            const targetInput = document.querySelector(this.dataset.target);
            if (targetInput) {
                const isPassword = targetInput.type === 'password';
                targetInput.type = isPassword ? 'text' : 'password';
                this.querySelector('i').classList.toggle('fa-eye-slash', !isPassword);
                this.querySelector('i').classList.toggle('fa-eye', isPassword);
            }
        });
    });

    form.addEventListener('submit', function(e) {
        if (submitBtn.disabled) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}